<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.6.1">
<meta name="author" content="WildFly clustering team">
<title>High Availability Guide</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove comment around @import statement below when using as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.spread{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:initial}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px 0}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:.4em .75em 0 .75em;line-height:1;vertical-align:top}
.colist>table tr>td:first-of-type img{max-width:initial}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;text-indent:-1.05em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]:after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
.sect1{padding-bottom:0!important}
.sect1+.sect1{border:0!important}
#header>h1:first-child{margin-top:1.25rem}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span:before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]:before{display:block}
#footer{background:none!important;padding:0 .9375em}
#footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">
<style>
/* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
/*pre.CodeRay {background-color:#f7f7f8;}*/
.CodeRay .line-numbers{border-right:1px solid #d8d8d8;padding:0 0.5em 0 .25em}
.CodeRay span.line-numbers{display:inline-block;margin-right:.5em;color:rgba(0,0,0,.3)}
.CodeRay .line-numbers strong{color:rgba(0,0,0,.4)}
table.CodeRay{border-collapse:separate;border-spacing:0;margin-bottom:0;border:0;background:none}
table.CodeRay td{vertical-align: top;line-height:1.45}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.line-numbers>pre{padding:0;color:rgba(0,0,0,.3)}
table.CodeRay td.code{padding:0 0 0 .5em}
table.CodeRay td.code>pre{padding:0}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>High Availability Guide</h1>
<div class="details">
<span id="author" class="author">WildFly clustering team</span><br>
<span id="revnumber">version {version},</span>
<span id="revdate">2017-09-18</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">High Availability Guide</div>
<ul class="sectlevel1">
<li><a href="#_introduction_to_high_availability_services">1. Introduction To High Availability Services</a>
<ul class="sectlevel2">
<li><a href="#what-are-high-availability-services">1.1. What are High Availability services?</a></li>
<li><a href="#high-availability-through-fail-over">1.2. High Availability through fail-over</a></li>
<li><a href="#high-availability-through-load-balancing">1.3. High Availability through load balancing</a></li>
<li><a href="#aims-of-the-guide">1.4. Aims of the guide</a></li>
<li><a href="#organization-of-the-guide">1.5. Organization of the guide</a></li>
</ul>
</li>
<li><a href="#_http_services">2. HTTP Services</a></li>
<li><a href="#_clustered_web_sessions">3. Clustered Web Sessions</a></li>
<li><a href="#_clustered_sso">4. Clustered SSO</a></li>
<li><a href="#_load_balancing">5. Load Balancing</a>
<ul class="sectlevel2">
<li><a href="#load-balancing-with-apache-mod_jk">5.1. Load balancing with Apache + mod_jk</a></li>
<li><a href="#load-balancing-with-apache-mod_cluster">5.2. Load balancing with Apache + mod_cluster</a></li>
<li><a href="#configuration">5.3. Configuration</a></li>
<li><a href="#runtime-operations">5.4. Runtime Operations</a></li>
<li><a href="#_apache_httpd">5.5. Apache httpd</a></li>
</ul>
</li>
<li><a href="#_ejb_services">6. EJB Services</a>
<ul class="sectlevel2">
<li><a href="#ejb-subsystem">6.1. EJB Subsystem</a></li>
<li><a href="#ejb-timer">6.2. EJB Timer</a></li>
</ul>
</li>
<li><a href="#_hibernate">7. Hibernate</a></li>
<li><a href="#_ha_singleton_features">8. HA Singleton Features</a></li>
<li><a href="#_singleton_subsystem">9. Singleton subsystem</a>
<ul class="sectlevel2">
<li><a href="#configuration">9.1. Configuration</a></li>
<li><a href="#non-ha-environments">9.2. Non-HA environments</a></li>
</ul>
</li>
<li><a href="#_singleton_deployments">10. Singleton deployments</a>
<ul class="sectlevel2">
<li><a href="#usage">10.1. Usage</a></li>
</ul>
</li>
<li><a href="#_singleton_msc_services">11. Singleton MSC services</a>
<ul class="sectlevel2">
<li><a href="#installing-an-msc-service-using-an-existing-singleton-policy">11.1. Installing an MSC service using an existing singleton policy</a></li>
<li><a href="#installing-an-msc-service-using-dynamic-singleton-policy">11.2. Installing an MSC service using dynamic singleton policy</a></li>
</ul>
</li>
<li><a href="#_related_topics">12. Related Topics</a>
<ul class="sectlevel2">
<li><a href="#modularity-and-class-loading">12.1. Modularity And Class Loading</a></li>
<li><a href="#monitoring">12.2. Monitoring</a></li>
</ul>
</li>
<li><a href="#_clustering_and_domain_setup_walkthrough">13. Clustering and Domain Setup Walkthrough</a>
<ul class="sectlevel2">
<li><a href="#preparation-scenario">13.1. Preparation &amp; Scenario</a></li>
<li><a href="#download-wildfly-9">13.2. Download WildFly 9</a></li>
<li><a href="#domain-configuration">13.3. Domain Configuration</a></li>
<li><a href="#deployment">13.4. Deployment</a></li>
<li><a href="#cluster-configuration">13.5. Cluster Configuration</a></li>
<li><a href="#testing">13.6. Testing</a></li>
<li><a href="#special-thanks">13.7. Special Thanks</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>&#169; 2017 The original authors.</p>
</div>
<!-- toc disabled -->
</div>
</div>
<div class="sect1">
<h2 id="_introduction_to_high_availability_services">1. Introduction To High Availability Services</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="what-are-high-availability-services">1.1. What are High Availability services?</h3>
<div class="paragraph">
<p>WildFly&#8217;s High Availability services are used to guarantee availability
of a deployed Java EE application.</p>
</div>
<div class="paragraph">
<p>Deploying critical applications on a single node suffers from two
potential problems:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>loss of application availability when the node hosting the application
crashes (single point of failure)</p>
</li>
<li>
<p>loss of application availability in the form of extreme delays in
response time during high volumes of requests (overwhelmed server)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>WildFly supports two features which ensure high availability of critical
Java EE applications:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>fail-over:</strong> allows a client interacting with a Java EE application to
have uninterrupted access to that application, even in the presence of
node failures</p>
</li>
<li>
<p><strong>load balancing:</strong> allows a client to have timely responses from the
application, even in the presence of high-volumes of requests</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
These two independent high availability services can very effectively
inter-operate when making use of mod_cluster for load balancing!
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Taking advantage of WildFly&#8217;s high availability services is easy, and
simply involves deploying WildFly on a cluster of nodes, making a small
number of application configuration changes, and then deploying the
application in the cluster.</p>
</div>
<div class="paragraph">
<p>We now take a brief look at what these services can guarantee.</p>
</div>
</div>
<div class="sect2">
<h3 id="high-availability-through-fail-over">1.2. High Availability through fail-over</h3>
<div class="paragraph">
<p>Fail-over allows a client interacting with a Java EE application to have
uninterrupted access to that application, even in the presence of node
failures. For example, consider a Java EE application which makes use of
the following features:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>session-oriented servlets to provide user interaction</p>
</li>
<li>
<p>session-oriented EJBs to perform state-dependent business computation</p>
</li>
<li>
<p>EJB entity beans to store critical data in a persistent store (e.g.
database)</p>
</li>
<li>
<p>SSO login to the application</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If the application makes use of WildFly&#8217;s fail-over services, a client
interacting with an instance of that application will not be interrupted
even when the node on which that instance executes crashes. Behind the
scenes, WildFly makes sure that all of the user data that the
application make use of (HTTP session data, EJB SFSB sessions, EJB
entities and SSO credentials) are available at other nodes in the
cluster, so that when a failure occurs and the client is redirected to
that new node for continuation of processing (i.e. the client "fails
over" to the new node), the user&#8217;s data is available and processing can
continue.</p>
</div>
<div class="paragraph">
<p>The Infinispan and JGroups subsystems are instrumental in providing
these data availability guarantees and will be discussed in detail later
in the guide.</p>
</div>
</div>
<div class="sect2">
<h3 id="high-availability-through-load-balancing">1.3. High Availability through load balancing</h3>
<div class="paragraph">
<p>Load balancing enables the application to respond to client requests in
a timely fashion, even when subjected to a high-volume of requests.
Using a load balancer as a front-end, each incoming HTTP request can be
directed to one node in the cluster for processing. In this way, the
cluster acts as a pool of processing nodes and the load is "balanced"
over the pool, achieving scalability and, as a consequence,
availability. Requests involving session-oriented servlets are directed
to the the same application instance in the pool for efficiency of
processing (sticky sessions). Using mod_cluster has the advantage that
changes in cluster topology (scaling the pool up or down, servers
crashing) are communicated back to the load balancer and used to update
in real time the load balancing activity and avoid requests being
directed to application instances which are no longer available.</p>
</div>
<div class="paragraph">
<p>The mod_cluster subsystem is instrumental in providing support for this
High Availability feature of WildFly and will be discussed in detail
later in this guide.</p>
</div>
</div>
<div class="sect2">
<h3 id="aims-of-the-guide">1.4. Aims of the guide</h3>
<div class="paragraph">
<p>This guide aims to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>provide a description of the high-availability features available in
WildFly and the services they depend on</p>
</li>
<li>
<p>show how the various high availability services can be configured for
particular application use cases</p>
</li>
<li>
<p>identify default behavior for features relating to
high-availability/clustering</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="organization-of-the-guide">1.5. Organization of the guide</h3>
<div class="paragraph">
<p>As high availability features and their configuration depend on the
particular component they affect (e.g. HTTP sessions, EJB SFSB sessions,
Hibernate), we organize the discussion around those Java EE features. We
strive to make each section as self-contained as possible. Also, when
discussing a feature, we will introduce any WildFly subsystems upon
which the feature depends.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_http_services">2. HTTP Services</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section summarizes the HTTP-based clustering features.</p>
</div>
<div class="paragraph">
<p>Unresolved directive in high-availability-guide/HTTP_Services.adoc - include::Subsystem_support.adoc[]</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_clustered_web_sessions">3. Clustered Web Sessions</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_clustered_sso">4. Clustered SSO</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_load_balancing">5. Load Balancing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section describes load balancing via Apache + mod_jk and Apache<br>
mod_cluster.</p>
</div>
<div class="sect2">
<h3 id="load-balancing-with-apache-mod_jk">5.1. Load balancing with Apache + mod_jk</h3>
<div class="paragraph">
<p>Describe load balancing with Apache using mod_jk.</p>
</div>
</div>
<div class="sect2">
<h3 id="load-balancing-with-apache-mod_cluster">5.2. Load balancing with Apache + mod_cluster</h3>
<div class="paragraph">
<p>Describe load balancing with Apache using mod_cluster.</p>
</div>
<div class="sect3">
<h4 id="mod_cluster-subsystem">5.2.1. mod_cluster Subsystem</h4>
<div class="paragraph">
<p>The mod_cluster integration is done via the
<a href="http://docs.jboss.org/mod_cluster/1.1.0/html/java.AS7config.html">modcluster
subsystem</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuration">5.3. Configuration</h3>
<div class="sect3">
<h4 id="instance-id-or-jvmroute">5.3.1. Instance ID or JVMRoute</h4>
<div class="paragraph">
<p>The instance-id or JVMRoute defaults to jboss.node.name property passed
on server startup (e.g. via -Djboss.node.name=XYZ).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="ruby">[standalone<span class="instance-variable">@localhost</span>:<span class="integer">9990</span> /] /subsystem=undertow/<span class="symbol">:read</span>-attribute(name=instance-id)
{
    <span class="string"><span class="delimiter">&quot;</span><span class="content">outcome</span><span class="delimiter">&quot;</span></span> =&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">success</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">result</span><span class="delimiter">&quot;</span></span> =&gt; expression <span class="string"><span class="delimiter">&quot;</span><span class="content">${jboss.node.name}</span><span class="delimiter">&quot;</span></span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To configure instance-id statically, configure the corresponding
property in Undertow subsystem:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="ruby">[standalone<span class="instance-variable">@localhost</span>:<span class="integer">9990</span> /] /subsystem=undertow/<span class="symbol">:write</span>-attribute(name=instance-id,value=myroute)
{
    <span class="string"><span class="delimiter">&quot;</span><span class="content">outcome</span><span class="delimiter">&quot;</span></span> =&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">success</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">response-headers</span><span class="delimiter">&quot;</span></span> =&gt; {
        <span class="string"><span class="delimiter">&quot;</span><span class="content">operation-requires-reload</span><span class="delimiter">&quot;</span></span> =&gt; <span class="predefined-constant">true</span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">process-state</span><span class="delimiter">&quot;</span></span> =&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">reload-required</span><span class="delimiter">&quot;</span></span>
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="proxies">5.3.2. Proxies</h4>
<div class="paragraph">
<p>By default, mod_cluster is configured for multicast-based discovery. To
specify a static list of proxies, create a remote-socket-binding for
each proxy and then reference them in the 'proxies' attribute. See the
following example for configuration in the domain mode:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="ruby">[domain<span class="instance-variable">@localhost</span>:<span class="integer">9990</span> /] /socket-binding-group=ha-sockets/remote-destination-outbound-socket-binding=<span class="key">proxy1</span>:add(host=<span class="float">10.21</span>.<span class="error">152.86</span>, port=<span class="integer">6666</span>)
{
    <span class="string"><span class="delimiter">&quot;</span><span class="content">outcome</span><span class="delimiter">&quot;</span></span> =&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">success</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">result</span><span class="delimiter">&quot;</span></span> =&gt; undefined,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">server-groups</span><span class="delimiter">&quot;</span></span> =&gt; undefined
}
[domain<span class="instance-variable">@localhost</span>:<span class="integer">9990</span> /] /socket-binding-group=ha-sockets/remote-destination-outbound-socket-binding=<span class="key">proxy2</span>:add(host=<span class="float">10.21</span>.<span class="error">152.87</span>, port=<span class="integer">6666</span>)
{
    <span class="string"><span class="delimiter">&quot;</span><span class="content">outcome</span><span class="delimiter">&quot;</span></span> =&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">success</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">result</span><span class="delimiter">&quot;</span></span> =&gt; undefined,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">server-groups</span><span class="delimiter">&quot;</span></span> =&gt; undefined
}
[domain<span class="instance-variable">@localhost</span>:<span class="integer">9990</span> /] /profile=ha/subsystem=modcluster/mod-cluster-config=configuration/<span class="symbol">:write</span>-attribute(name=proxies, value=[proxy1, proxy2]
{
    <span class="string"><span class="delimiter">&quot;</span><span class="content">outcome</span><span class="delimiter">&quot;</span></span> =&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">success</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">result</span><span class="delimiter">&quot;</span></span> =&gt; undefined,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">server-groups</span><span class="delimiter">&quot;</span></span> =&gt; undefined
}
[domain<span class="instance-variable">@localhost</span>:<span class="integer">9990</span> /] <span class="symbol">:reload</span>-servers
{
    <span class="string"><span class="delimiter">&quot;</span><span class="content">outcome</span><span class="delimiter">&quot;</span></span> =&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">success</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">result</span><span class="delimiter">&quot;</span></span> =&gt; undefined,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">server-groups</span><span class="delimiter">&quot;</span></span> =&gt; undefined
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="runtime-operations">5.4. Runtime Operations</h3>
<div class="paragraph">
<p>The modcluster subsystem supports several operations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="ruby">[standalone<span class="instance-variable">@localhost</span>:<span class="integer">9999</span> subsystem=modcluster] <span class="symbol">:read</span>-operation-names
{
    <span class="string"><span class="delimiter">&quot;</span><span class="content">outcome</span><span class="delimiter">&quot;</span></span> =&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">success</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">result</span><span class="delimiter">&quot;</span></span> =&gt; [
        <span class="string"><span class="delimiter">&quot;</span><span class="content">add</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">add-custom-metric</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">add-metric</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">add-proxy</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">disable</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">disable-context</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">enable</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">enable-context</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">list-proxies</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">read-attribute</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">read-children-names</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">read-children-resources</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">read-children-types</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">read-operation-description</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">read-operation-names</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">read-proxies-configuration</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">read-proxies-info</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">read-resource</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">read-resource-description</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">refresh</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">remove-custom-metric</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">remove-metric</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">remove-proxy</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">reset</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">stop</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">stop-context</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">validate-address</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">write-attribute</span><span class="delimiter">&quot;</span></span>
    ]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The operations specific to the modcluster subsystem are divided in 3
categories the ones that affects the configuration and require a restart
of the subsystem, the one that just modify the behaviour temporarily and
the ones that display information from the httpd part.</p>
</div>
<div class="sect3">
<h4 id="operations-displaying-httpd-informations">5.4.1. operations displaying httpd informations</h4>
<div class="paragraph">
<p>There are 2 operations that display how Apache httpd sees the node:</p>
</div>
<div class="sect4">
<h5 id="read-proxies-configuration">read-proxies-configuration</h5>
<div class="paragraph">
<p>Send a DUMP message to all Apache httpd the node is connected to and
display the message received from Apache httpd.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="ruby">[standalone<span class="instance-variable">@localhost</span>:<span class="integer">9999</span> subsystem=modcluster] <span class="symbol">:read</span>-proxies-configuration
{
    <span class="string"><span class="delimiter">&quot;</span><span class="content">outcome</span><span class="delimiter">&quot;</span></span> =&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">success</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">result</span><span class="delimiter">&quot;</span></span> =&gt; [
        <span class="string"><span class="delimiter">&quot;</span><span class="content">neo3:6666</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">balancer: [1] Name: mycluster Sticky: 1 [JSESSIONID]/[jsessionid] remove: 0 force: 1 Timeout: 0 Maxtry: 1
node: [1:1],Balancer: mycluster,JVMRoute: 498bb1f0-00d9-3436-a341-7f012bc2e7ec,Domain: [],Host: 127.0.0.1,Port: 8080,Type: http,flushpackets: 0,flushwait: 10,ping: 10,smax: 26,ttl: 60,timeout: 0
host: 1 [example.com] vhost: 1 node: 1
host: 2 [localhost] vhost: 1 node: 1
host: 3 [default-host] vhost: 1 node: 1
context: 1 [/myapp] vhost: 1 node: 1 status: 1
context: 2 [/] vhost: 1 node: 1 status: 1
</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">jfcpc:6666</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">balancer: [1] Name: mycluster Sticky: 1 [JSESSIONID]/[jsessionid] remove: 0 force: 1 Timeout: 0 maxAttempts: 1
node: [1:1],Balancer: mycluster,JVMRoute: 498bb1f0-00d9-3436-a341-7f012bc2e7ec,LBGroup: [],Host: 127.0.0.1,Port: 8080,Type: http,flushpackets: 0,flushwait: 10,ping: 10,smax: 26,ttl: 60,timeout: 0
host: 1 [default-host] vhost: 1 node: 1
host: 2 [localhost] vhost: 1 node: 1
host: 3 [example.com] vhost: 1 node: 1
context: 1 [/] vhost: 1 node: 1 status: 1
context: 2 [/myapp] vhost: 1 node: 1 status: 1
</span><span class="delimiter">&quot;</span></span>
    ]
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="read-proxies-info">read-proxies-info</h5>
<div class="paragraph">
<p>Send a INFO message to all Apache httpd the node is connected to and
display the message received from Apache httpd.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="ruby">[standalone<span class="instance-variable">@localhost</span>:<span class="integer">9999</span> subsystem=modcluster] <span class="symbol">:read</span>-proxies-info
{
    <span class="string"><span class="delimiter">&quot;</span><span class="content">outcome</span><span class="delimiter">&quot;</span></span> =&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">success</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">result</span><span class="delimiter">&quot;</span></span> =&gt; [
        <span class="string"><span class="delimiter">&quot;</span><span class="content">neo3:6666</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">Node: [1],Name: 498bb1f0-00d9-3436-a341-7f012bc2e7ec,Balancer: mycluster,Domain: ,Host: 127.0.0.1,Port: 8080,Type: http,Flushpackets: Off,Flushwait: 10000,Ping: 10000000,Smax: 26,Ttl: 60000000,Elected: 0,Read: 0,Transfered: 0,Connected: 0,Load: -1
Vhost: [1:1:1], Alias: example.com
Vhost: [1:1:2], Alias: localhost
Vhost: [1:1:3], Alias: default-host
Context: [1:1:1], Context: /myapp, Status: ENABLED
Context: [1:1:2], Context: /, Status: ENABLED
</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">jfcpc:6666</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">Node: [1],Name: 498bb1f0-00d9-3436-a341-7f012bc2e7ec,Balancer: mycluster,LBGroup: ,Host: 127.0.0.1,Port: 8080,Type: http,Flushpackets: Off,Flushwait: 10,Ping: 10,Smax: 26,Ttl: 60,Elected: 0,Read: 0,Transfered: 0,Connected: 0,Load: 1
Vhost: [1:1:1], Alias: default-host
Vhost: [1:1:2], Alias: localhost
Vhost: [1:1:3], Alias: example.com
Context: [1:1:1], Context: /, Status: ENABLED
Context: [1:1:2], Context: /myapp, Status: ENABLED
</span><span class="delimiter">&quot;</span></span>
    ]
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="operations-that-handle-the-proxies-the-node-is-connected-too">operations that handle the proxies the node is connected too</h5>
<div class="paragraph">
<p>there are 3 operation that could be used to manipulate the list of
Apache httpd the node is connected too.</p>
</div>
</div>
<div class="sect4">
<h5 id="list-proxies">list-proxies:</h5>
<div class="paragraph">
<p>Displays the httpd that are connected to the node. The httpd could be
discovered via the Advertise protocol or via the proxy-list attribute.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="ruby">[standalone<span class="instance-variable">@localhost</span>:<span class="integer">9999</span> subsystem=modcluster] <span class="symbol">:list</span>-proxies
{
    <span class="string"><span class="delimiter">&quot;</span><span class="content">outcome</span><span class="delimiter">&quot;</span></span> =&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">success</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">result</span><span class="delimiter">&quot;</span></span> =&gt; [
        <span class="string"><span class="delimiter">&quot;</span><span class="content">proxy1:6666</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">proxy2:6666</span><span class="delimiter">&quot;</span></span>
    ]
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="remove-proxy">remove-proxy</h5>
<div class="paragraph">
<p>Remove a proxy from the discovered proxies or temporarily from the
proxy-list attribute.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="ruby">[standalone<span class="instance-variable">@localhost</span>:<span class="integer">9999</span> subsystem=modcluster] <span class="symbol">:remove</span>-proxy(host=jfcpc, port=<span class="integer">6666</span>)
{<span class="string"><span class="delimiter">&quot;</span><span class="content">outcome</span><span class="delimiter">&quot;</span></span> =&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">success</span><span class="delimiter">&quot;</span></span>}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="add-proxy">add-proxy</h5>
<div class="paragraph">
<p>Add a proxy to the discovered proxies or temporarily to the proxy-list
attribute.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">[standalone<span class="annotation">@localhost</span>:<span class="integer">9999</span> subsystem=modcluster] :add-proxy(host=jfcpc, port=<span class="integer">6666</span>)
{<span class="string"><span class="delimiter">&quot;</span><span class="content">outcome</span><span class="delimiter">&quot;</span></span> =&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">success</span><span class="delimiter">&quot;</span></span>}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="context-related-operations">5.4.2. Context related operations</h4>
<div class="paragraph">
<p>Those operations allow to send context related commands to Apache httpd.
They are send automatically when deploying or undeploying webapps.</p>
</div>
<div class="sect4">
<h5 id="enable-context">enable-context</h5>
<div class="paragraph">
<p>Tell Apache httpd that the context is ready receive requests.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="ruby">[standalone<span class="instance-variable">@localhost</span>:<span class="integer">9999</span> subsystem=modcluster] <span class="symbol">:enable</span>-context(context=<span class="regexp"><span class="delimiter">/</span><span class="content">myapp, virtualhost=default-host)
{&quot;outcome&quot; =&gt; &quot;success&quot;}</span></span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="disable-context">disable-context</h5>
<div class="paragraph">
<p>Tell Apache httpd that it shouldn&#8217;t send new session requests to the
context of the virtualhost.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="ruby">[standalone<span class="instance-variable">@localhost</span>:<span class="integer">9999</span> subsystem=modcluster] <span class="symbol">:disable</span>-context(context=<span class="regexp"><span class="delimiter">/</span><span class="content">myapp, virtualhost=default-host)
{&quot;outcome&quot; =&gt; &quot;success&quot;}</span></span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="stop-context">stop-context</h5>
<div class="paragraph">
<p>Tell Apache httpd that it shouldn&#8217;t send requests to the context of the
virtualhost.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="ruby">[standalone<span class="instance-variable">@localhost</span>:<span class="integer">9999</span> subsystem=modcluster] <span class="symbol">:stop</span>-context(context=<span class="regexp"><span class="delimiter">/</span><span class="content">myapp, virtualhost=default-host, waittime=50)
{&quot;outcome&quot; =&gt; &quot;success&quot;}</span></span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="node-related-operations">5.4.3. Node related operations</h4>
<div class="paragraph">
<p>Those operations are like the context operation but they apply to all
webapps running on the node and operation that affect the whole node.</p>
</div>
<div class="sect4">
<h5 id="refresh">refresh</h5>
<div class="paragraph">
<p>Refresh the node by sending a new CONFIG message to Apache httpd.</p>
</div>
</div>
<div class="sect4">
<h5 id="reset">reset</h5>
<div class="paragraph">
<p>reset the connection between Apache httpd and the node</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configuration-1">5.4.4. Configuration</h4>
<div class="sect4">
<h5 id="metric-configuration">Metric configuration</h5>
<div class="paragraph">
<p>There are 4 metric operations corresponding to add and remove load
metrics to the dynamic-load-provider. Note that when nothing is defined
a simple-load-provider is use with a fixed load factor of one.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="ruby">[standalone<span class="instance-variable">@localhost</span>:<span class="integer">9999</span> subsystem=modcluster] <span class="symbol">:read</span>-resource(name=mod-cluster-config)
{
    <span class="string"><span class="delimiter">&quot;</span><span class="content">outcome</span><span class="delimiter">&quot;</span></span> =&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">success</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">result</span><span class="delimiter">&quot;</span></span> =&gt; {<span class="string"><span class="delimiter">&quot;</span><span class="content">simple-load-provider</span><span class="delimiter">&quot;</span></span> =&gt; {<span class="string"><span class="delimiter">&quot;</span><span class="content">factor</span><span class="delimiter">&quot;</span></span> =&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span>}}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>that corresponds to the following configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;subsystem</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:domain:modcluster:1.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;mod-cluster-config&gt;</span>
                <span class="tag">&lt;simple-load-provider</span> <span class="attribute-name">factor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/mod-cluster-config&gt;</span>
 <span class="tag">&lt;/subsystem&gt;</span></code></pre>
</div>
</div>
<div class="sect5">
<h6 id="add-metric">add-metric</h6>
<div class="paragraph">
<p>Add a metric to the dynamic-load-provider, the dynamic-load-provider in
configuration is created if needed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="ruby">[standalone<span class="instance-variable">@localhost</span>:<span class="integer">9999</span> subsystem=modcluster] <span class="symbol">:add</span>-metric(type=cpu)
{<span class="string"><span class="delimiter">&quot;</span><span class="content">outcome</span><span class="delimiter">&quot;</span></span> =&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">success</span><span class="delimiter">&quot;</span></span>}
[standalone<span class="instance-variable">@localhost</span>:<span class="integer">9999</span> subsystem=modcluster] <span class="symbol">:read</span>-resource(name=mod-cluster-config)
{
    <span class="string"><span class="delimiter">&quot;</span><span class="content">outcome</span><span class="delimiter">&quot;</span></span> =&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">success</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">result</span><span class="delimiter">&quot;</span></span> =&gt; {
        <span class="string"><span class="delimiter">&quot;</span><span class="content">dynamic-load-provider</span><span class="delimiter">&quot;</span></span> =&gt; {
            <span class="string"><span class="delimiter">&quot;</span><span class="content">history</span><span class="delimiter">&quot;</span></span> =&gt; <span class="integer">9</span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">decay</span><span class="delimiter">&quot;</span></span> =&gt; <span class="integer">2</span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">load-metric</span><span class="delimiter">&quot;</span></span> =&gt; [{
                <span class="string"><span class="delimiter">&quot;</span><span class="content">type</span><span class="delimiter">&quot;</span></span> =&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">cpu</span><span class="delimiter">&quot;</span></span>
            }]
        }
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="remove-metric">remove-metric</h6>
<div class="paragraph">
<p>Remove a metric from the dynamic-load-provider.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="ruby">[standalone<span class="instance-variable">@localhost</span>:<span class="integer">9999</span> subsystem=modcluster] <span class="symbol">:remove</span>-metric(type=cpu)
{<span class="string"><span class="delimiter">&quot;</span><span class="content">outcome</span><span class="delimiter">&quot;</span></span> =&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">success</span><span class="delimiter">&quot;</span></span>}</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="add-custom-metric-remove-custom-metric">add-custom-metric / remove-custom-metric</h6>
<div class="paragraph">
<p>like the add-metric and remove-metric except they require a class
parameter instead the type. Usually they needed additional properties
which can be specified</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="ruby">[standalone<span class="instance-variable">@localhost</span>:<span class="integer">9999</span> subsystem=modcluster] <span class="symbol">:add</span>-custom-metric(<span class="keyword">class</span>=myclass, property=[(<span class="string"><span class="delimiter">&quot;</span><span class="content">pro1</span><span class="delimiter">&quot;</span></span> =&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">value1</span><span class="delimiter">&quot;</span></span>), (<span class="string"><span class="delimiter">&quot;</span><span class="content">pro2</span><span class="delimiter">&quot;</span></span> =&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">value2</span><span class="delimiter">&quot;</span></span>)]
{<span class="string"><span class="delimiter">&quot;</span><span class="content">outcome</span><span class="delimiter">&quot;</span></span> =&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">success</span><span class="delimiter">&quot;</span></span>}</code></pre>
</div>
</div>
<div class="paragraph">
<p>which corresponds the following in the xml configuration file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;subsystem</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:domain:modcluster:1.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;mod-cluster-config&gt;</span>
                <span class="tag">&lt;dynamic-load-provider</span> <span class="attribute-name">history</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">9</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">decay</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                    <span class="tag">&lt;custom-load-metric</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myclass</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">pro1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">value1</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">pro2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">value2</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                    <span class="tag">&lt;/custom-load-metric&gt;</span>
                <span class="tag">&lt;/dynamic-load-provider&gt;</span>
            <span class="tag">&lt;/mod-cluster-config&gt;</span>
<span class="tag">&lt;/subsystem&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_apache_httpd">5.5. Apache httpd</h3>
<div class="paragraph">
<p>The recommended front-end module is mod_cluster but mod_jk or mod_proxy
could be used as in Tomcat or other AS version.</p>
</div>
<div class="paragraph">
<p>To use AJP define a ajp connector in the web subsystem like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;subsystem</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:domain:web:1.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> +
<span class="tag">&lt;connector</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">protocol</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">HTTP/1.1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">socket-binding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> +
<span class="tag">&lt;connector</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ajp</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">protocol</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">AJP/1.3</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">socket-binding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ajp</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>sTo the ajp in the in the socket-binding-group like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;socket-binding-group</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">standard-sockets</span><span class="delimiter">&quot;</span></span>
<span class="attribute-name">default-interface</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">public</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> +
.... +
<span class="tag">&lt;socket-binding</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">8080</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> +
<span class="tag">&lt;socket-binding</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ajp</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">8009</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> +
<span class="tag">&lt;socket-binding</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">8443</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ejb_services">6. EJB Services</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This chapter explains how clustering of EJBs works in WildFly 11.</p>
</div>
<div class="sect2">
<h3 id="ejb-subsystem">6.1. EJB Subsystem</h3>

</div>
<div class="sect2">
<h3 id="ejb-timer">6.2. EJB Timer</h3>
<div class="paragraph">
<p>Wildfly now supports clustered database backed timers. For details have
a look to the
<a href="https://docs.jboss.org/author/display/WFLY/EJB3+Clustered+Database+Timers">EJB3
reference section</a></p>
</div>
<div class="sect3">
<h4 id="marking-an-ejb-as-clustered">6.2.1. Marking an EJB as clustered</h4>
<div class="paragraph">
<p>WildFly 11 allows clustering of stateful session beans. A stateful
session bean can be marked with <code>@org.jboss.ejb3.annotation.Clustered</code>
annotation or be marked as clustered using the jboss-ejb3.xml&#8217;s
<code>&lt;clustered&gt;</code> element.</p>
</div>
<div class="paragraph">
<p>MyStatefulBean</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.jboss.ejb3.annotation.Clustered</span>;
<span class="keyword">import</span> <span class="include">javax.ejb.Stateful</span>;
<span class="error"> </span>
<span class="annotation">@Stateful</span>
<span class="annotation">@Clustered</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">MyStatefulBean</span> {
...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>jboss-ejb3.xml</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">&lt;jboss xmlns=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.jboss.com/xml/ns/javaee</span><span class="delimiter">&quot;</span></span>
       xmlns:jee=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://java.sun.com/xml/ns/javaee</span><span class="delimiter">&quot;</span></span>
       xmlns:c=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:clustering:1.0</span><span class="delimiter">&quot;</span></span>&gt;
<span class="error"> </span>
<span class="error"> </span>
    &lt;jee:assembly-descriptor&gt;
        &lt;c:clustering&gt;
            &lt;jee:ejb-name&gt;DDBasedClusteredBean&lt;/jee:ejb-name&gt;
            &lt;c:clustered&gt;<span class="predefined-constant">true</span>&lt;/c:clustered&gt;
        &lt;/c:clustering&gt;
    &lt;/jee:assembly-descriptor&gt;
&lt;/jboss&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="deploying-clustered-ejbs">6.2.2. Deploying clustered EJBs</h4>
<div class="paragraph">
<p>Clustering support is available in the HA profiles of WildFly 11. In this
chapter we&#8217;ll be using the standalone server for explaining the details.
However, the same applies to servers in a domain mode. Starting the
standalone server with HA capabilities enabled, involves starting it
with the standalone-ha.xml (or even standalone-full-ha.xml):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">./standalone.sh -server-config=standalone-ha.xml</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will start a single instance of the server with HA capabilities.
Deploying the EJBs to this instance <em>doesn&#8217;t</em> involve anything special
and is the same as explained in the <a href="#src-557295">application
deployment chapter</a>.</p>
</div>
<div class="paragraph">
<p>Obviously, to be able to see the benefits of clustering, you&#8217;ll need
more than one instance of the server. So let&#8217;s start another server with
HA capabilities. That another instance of the server can either be on
the same machine or on some other machine. If it&#8217;s on the same machine,
the two things you have to make sure is that you pass the port offset
for the second instance and also make sure that each of the server
instances have a unique <code>jboss.node.name</code> system property. You can do
that by passing the following two system properties to the startup
command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">./standalone.sh -server-config=standalone-ha.xml -Djboss.socket.binding.port-offset=&lt;offset of your choice&gt; -Djboss.node.name=&lt;unique node name&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Follow whichever approach you feel comfortable with for deploying the
EJB deployment to this instance too.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Deploying the application on just one node of a standalone instance of a
clustered server does <strong>not</strong> mean that it will be automatically deployed
to the other clustered instance. You will have to do deploy it
explicitly on the other standalone clustered instance too. Or you can
start the servers in domain mode so that the deployment can be deployed
to all the server within a server group. See the
<a href="https://docs.jboss.org/author/display/AS71/Admin+Guide">admin guide</a> for
more details on domain setup.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now that you have deployed an application with clustered EJBs on both
the instances, the EJBs are now capable of making use of the clustering
features.</p>
</div>
</div>
<div class="sect3">
<h4 id="failover-for-clustered-ejbs">6.2.3. Failover for clustered EJBs</h4>
<div class="paragraph">
<p>Clustered EJBs have failover capability. The state of the @Stateful
@Clustered EJBs is replicated across the cluster nodes so that if one of
the nodes in the cluster goes down, some other node will be able to take
over the invocations. Let&#8217;s see how it&#8217;s implemented in WildFly 11. In
the next few sections we&#8217;ll see how it works for remote (standalone)
clients and for clients in another remote WildFly server instance.
Although, there isn&#8217;t a difference in how it works in both these cases,
we&#8217;ll still explain it separately so as to make sure there aren&#8217;t any
unanswered questions.</p>
</div>
<div class="sect4">
<h5 id="remote-standalone-clients">Remote standalone clients</h5>
<div class="paragraph">
<p>In this section we&#8217;ll consider a remote standalone client (i.e. a client
which runs in a separate JVM and <em>isn&#8217;t</em> running within another WildFly
8 instance). Let&#8217;s consider that we have 2 servers, server X and server
Y which we started earlier. Each of these servers has the clustered EJB
deployment. A standalone remote client can use either the
<a href="#src-557295">JNDI approach</a> or native JBoss EJB client APIs to
communicate with the servers. The important thing to note is that when
you are invoking clustered EJB deployments, you do <strong>not</strong> have to list
all the servers within the cluster (which obviously wouldn&#8217;t have been
feasible due the dynamic nature of cluster node additions within a
cluster).</p>
</div>
<div class="paragraph">
<p>The remote client just has to list only one of the servers with the
clustering capability. In this case, we can either list server X (in
jboss-ejb-client.properties) <em>or</em> server Y. This server will act as the
starting point for cluster topology communication between the client and
the clustered nodes.</p>
</div>
<div class="paragraph">
<p>Note that you have to configure the <em>ejb</em> cluster in the
jboss-ejb-client.properties configuration file, like so:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">remote.clusters=ejb
remote.cluster.ejb.connect.options.org.xnio.Options.SASL_POLICY_NOANONYMOUS=<span class="predefined-constant">false</span>
remote.cluster.ejb.connect.options.org.xnio.Options.SSL_ENABLED=<span class="predefined-constant">false</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="cluster-topology-communication">Cluster topology communication</h5>
<div class="paragraph">
<p>When a client connects to a server, the JBoss EJB client implementation
(internally) communicates with the server for cluster topology
information, if the server had clustering capability. In our example
above, let&#8217;s assume we listed server X as the initial server to connect
to. When the client connects to server X, the server will send back an
(asynchronous) cluster topology message to the client. This topology
message consists of the cluster name(s) and the information of the nodes
that belong to the cluster. The node information includes the node
address and port number to connect to (whenever necessary). So in this
example, the server X will send back the cluster topology consisting of
the other server Y which belongs to the cluster.</p>
</div>
<div class="paragraph">
<p>In case of stateful (clustered) EJBs, a typical invocation flow involves
creating of a session for the stateful bean, which happens when you do a
JNDI lookup for that bean, and then invoking on the returned proxy. The
lookup for stateful bean, internally, triggers a (synchronous) session
creation request from the client to the server. In this case, the
session creation request goes to server X since that&#8217;s the initial
connection that we have configured in our jboss-ejb-client.properties.
Since server X is clustered, it will return back a session id and along
with send back an <em>"affinity"</em> of that session. In case of clustered
servers, the affinity equals to the name of the cluster to which the
stateful bean belongs on the server side. For non-clustered beans, the
affinity is just the node name on which the session was created. This
<em>affinity</em> will later help the EJB client to route the invocations on
the proxy, appropriately to either a node within a cluster (for
clustered beans) or to a specific node (for non-clustered beans). While
this session creation request is going on, the server X will also send
back an asynchronous message which contains the cluster topology. The
JBoss EJB client implementation will take note of this topology
information and will later use it for connection creation to nodes
within the cluster and routing invocations to those nodes, whenever
necessary.</p>
</div>
<div class="paragraph">
<p>Now that we know how the cluster topology information is communicated
from the server to the client, let see how failover works. Let&#8217;s
continue with the example of server X being our starting point and a
client application looking up a stateful bean and invoking on it. During
these invocations, the client side will have collected the cluster
topology information from the server. Now let&#8217;s assume for some reason,
server X goes down and the client application subsequent invokes on the
proxy. The JBoss EJB client implementation, at this stage will be aware
of the affinity and in this case it&#8217;s a cluster affinity. Because of the
cluster topology information it has, it knows that the cluster has two
nodes server X and server Y. When the invocation now arrives, it sees
that the server X is down. So it uses a selector to fetch a suitable
node from among the cluster nodes. The selector itself is configurable,
but we&#8217;ll leave it from discussion for now. When the selector returns a
node from among the cluster, the JBoss EJB client implementation creates
a connection to that node (if not already created earlier) and creates a
EJB receiver out of it. Since in our example, the only other node in the
cluster is server Y, the selector will return that node and the JBoss
EJB client implementation will use it to create a EJB receiver out of it
and use that receiver to pass on the invocation on the proxy.
Effectively, the invocation has now failed over to a different node
within the cluster.</p>
</div>
</div>
<div class="sect4">
<h5 id="remote-clients-on-another-instance-of-wildfly-8">Remote clients on another instance of WildFly 11</h5>
<div class="paragraph">
<p>So far we discussed remote standalone clients which typically use either
the EJB client API or the jboss-ejb-client.properties based approach to
configure and communicate with the servers where the clustered beans are
deployed. Now let&#8217;s consider the case where the client is an application
deployed another AS7 instance and it wants to invoke on a clustered
stateful bean which is deployed on another instance of WildFly 11. In
this example let&#8217;s consider a case where we have 3 servers involved.
Server X and Server Y both belong to a cluster and have clustered EJB
deployed on them. Let&#8217;s consider another server instance Server C (which
may or may <em>not</em> have clustering capability) which acts as a client on
which there&#8217;s a deployment which wants to invoke on the clustered beans
deployed on server X and Y and achieve failover.</p>
</div>
<div class="paragraph">
<p>The configurations required to achieve this are explained in
<a href="#src-557295">this chapter</a>. As you can see the configurations are
done in a jboss-ejb-client.xml which points to a remote outbound
connection to the other server. This jboss-ejb-client.xml goes in the
deployment of server C (since that&#8217;s our client). As explained eariler,
the client configuration need <strong>not</strong> point to all clustered nodes.
Instead it just has to point to one of them which will act as a start
point for communication. So in this case, we can create a remote
outbound connection on server C to server X and use server X as our
starting point for communication. Just like in the case of remote
standalone clients, when the application on server C (client) looks up a
stateful bean, a session creation request will be sent to server X which
will send back a session id and the cluster affinity for it.
Furthermore, server X asynchronously send back a message to server C
(client) containing the cluster topology. This topology information will
include the node information of server Y (since that belongs to the
cluster along with server X). Subsequent invocations on the proxy will
be routed appropriately to the nodes in the cluster. If server X goes
down, as explained earlier, a different node from the cluster will be
selected and the invocation will be forwarded to that node.</p>
</div>
<div class="paragraph">
<p>As can be seen both remote standalone client and remote clients on
another WildFly 11 instance act similar in terms of failover.</p>
</div>
</div>
<div class="sect4">
<h5 id="testcases-for-failover-of-stateful-beans">Testcases for failover of stateful beans</h5>
<div class="paragraph">
<p>We have testcases in WildFly 11 testsuite which test that whatever is
explained above works as expected. The
<a href="https://github.com/wildfly/wildfly/blob/master/testsuite/integration/clust/src/test/java/org/jboss/as/test/clustering/cluster/ejb3/stateful/remote/failover/RemoteEJBClientStatefulBeanFailoverTestCase.java">RemoteEJBClientStatefulBeanFailoverTestCase</a>
tests the case where a stateful EJB uses @Clustered annotation to mark
itself as clustered. We also have
<a href="https://github.com/wildfly/wildfly/blob/master/testsuite/integration/clust/src/test/java/org/jboss/as/test/clustering/cluster/ejb3/stateful/remote/failover/dd/RemoteEJBClientDDBasedSFSBFailoverTestCase.java">RemoteEJBClientDDBasedSFSBFailoverTestCase</a>
which uses jboss-ejb3.xml to mark a stateful EJB as clustered. Both
these testcases test that when a node goes down in a cluster, the client
invocation is routed to a different node in the cluster.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_hibernate">7. Hibernate</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_ha_singleton_features">8. HA Singleton Features</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In general, an HA or clustered singleton is a service that exists on
multiple nodes in a cluster, but is active on just a single node at any
given time. If the node providing the service fails or is shut down, a
new singleton provider is chosen and started. Thus, other than a brief
interval when one provider has stopped and another has yet to start, the
service is always running on one node.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_singleton_subsystem">9. Singleton subsystem</h2>
<div class="sectionbody">
<div class="paragraph">
<p>WildFly 10 introduces a "singleton" subsystem, which defines a set of
policies that define how an HA singleton should behave. A singleton
policy can be used to instrument singleton deployments or to create
singleton MSC services.</p>
</div>
<div class="sect2">
<h3 id="configuration">9.1. Configuration</h3>
<div class="paragraph">
<p>The
<a href="https://github.com/wildfly/wildfly/blob/10.0.0.Final/clustering/singleton/extension/src/main/resources/schema/wildfly-singleton_1_0.xsd">default
subsystem configuration</a> from WildFly&#8217;s ha and full-ha profile looks
like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;subsystem</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:domain:singleton:1.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;singleton-policies</span> <span class="attribute-name">default</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;singleton-policy</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">cache-container</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">server</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;simple-election-policy</span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/singleton-policy&gt;</span>
    <span class="tag">&lt;/singleton-policies&gt;</span>
<span class="tag">&lt;/subsystem&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A singleton policy defines:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A unique name</p>
</li>
<li>
<p>A cache container and cache with which to register singleton
provider candidates</p>
</li>
<li>
<p>An election policy</p>
</li>
<li>
<p>A quorum (optional)</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>One can add a new singleton policy via the following management
operation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">/subsystem=singleton/singleton-policy=foo:add(cache-container=server)</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="cache-configuration">9.1.1. Cache configuration</h4>
<div class="paragraph">
<p>The cache-container and cache attributes of a singleton policy must
reference a valid cache from the Infinispan subsystem. If no specific
cache is defined, the default cache of the cache container is assumed.
This cache is used as a registry of which nodes can provide a given
service and will typically use a replicated-cache configuration.</p>
</div>
</div>
<div class="sect3">
<h4 id="election-policies">9.1.2. Election policies</h4>
<div class="paragraph">
<p>WildFly 10 includes 2 singleton election policy implementations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>simple</strong><br>
Elects the provider (a.k.a. master) of a singleton service based on a
specified position in a circular linked list of eligible nodes sorted by
descending age. Position=0, the default value, refers to the oldest
node, 1 is second oldest, etc. ; while position=-1 refers to the
youngest node, -2 to the second youngest, etc.<br>
e.g.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">/subsystem=singleton/singleton-policy=foo/election-policy=simple:add(position=-1)</code></pre>
</div>
</div>
</li>
<li>
<p><strong>random</strong><br>
Elects a random member to be the provider of a singleton service<br>
e.g.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">/subsystem=singleton/singleton-policy=foo/election-policy=random:add()</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="preferences">Preferences</h5>
<div class="paragraph">
<p>Additionally, any singleton election policy may indicate a preference
for one or more members of a cluster. Preferences may be defined either
via node name or via outbound socket binding name. Node preferences
always take precedent over the results of an election policy.<br>
e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">/subsystem=singleton/singleton-policy=foo/election-policy=simple:list-add(name=name-preferences, value=nodeA)
/subsystem=singleton/singleton-policy=bar/election-policy=random:list-add(name=socket-binding-preferences, value=nodeA)</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="quorum">9.1.3. Quorum</h4>
<div class="paragraph">
<p>Network partitions are particularly problematic for singleton services,
since they can trigger multiple singleton providers for the same service
to run at the same time. To defend against this scenario, a singleton
policy may define a quorum that requires a minimum number of nodes to be
present before a singleton provider election can take place. A typical
deployment scenario uses a quorum of N/2 + 1, where N is the anticipated
cluster size. This value can be updated at runtime, and will immediately
affect any active singleton services.<br>
e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>/subsystem=singleton/singleton-policy=foo:write-attribute(name=quorum, value=3)</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="non-ha-environments">9.2. Non-HA environments</h3>
<div class="paragraph">
<p>The singleton subsystem can be used in a non-HA profile, so long as the
cache that it references uses a local-cache configuration. In this
manner, an application leveraging singleton functionality (via the
singleton API or using a singleton deployment descriptor) will continue
function as if the server was a sole member of a cluster. For obvious
reasons, the use of a quorum does not make sense in such a
configuration.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_singleton_deployments">10. Singleton deployments</h2>
<div class="sectionbody">
<div class="paragraph">
<p>WildFly 10 resurrects the ability to start a given deployment on a
single node in the cluster at any given time. If that node shuts down,
or fails, the application will automatically start on another node on
which the given deployment exists. Long time users of JBoss AS will
recognize this functionality as being akin to the
<a href="https://docs.jboss.org/jbossclustering/cluster_guide/5.1/html/deployment.chapt.html#d0e1220">HASingletonDeployer</a>,
a.k.a. "
<a href="https://docs.jboss.org/jbossclustering/cluster_guide/5.1/html/deployment.chapt.html#d0e1220">deploy-hasingleton</a>",
feature of AS6 and earlier.</p>
</div>
<div class="sect2">
<h3 id="usage">10.1. Usage</h3>
<div class="paragraph">
<p>A deployment indicates that it should be deployed as a singleton via a
deployment descriptor. This can either be a standalone
"/META-INF/singleton-deployment.xml" file or embedded within an existing
jboss-all.xml descriptor. This descriptor may be applied to any
deployment type, e.g. JAR, WAR, EAR, etc., with the exception of a
subdeployment within an EAR.<br>
e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;singleton-deployment</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:singleton-deployment:1.0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">policy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">foo</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The singleton deployment descriptor defines which
<a href="#src-557153">singleton policy</a> should be used to deploy the
application. If undefined, the default singleton policy is used, as
defined by the singleton subsystem.</p>
</div>
<div class="paragraph">
<p>Using a standalone descriptor is often preferable, since it may be
overlaid onto an existing deployment archive.<br>
e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>deployment-overlay add --name=singleton-policy-foo --content=/META-INF/singleton-deployment.xml=/path/to/singleton-deployment.xml --deployments=my-app.jar --redeploy-affected</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_singleton_msc_services">11. Singleton MSC services</h2>
<div class="sectionbody">
<div class="paragraph">
<p>WildFly allows any user MSC service to be installed as a singleton MSC
service via a public API. Once installed, the service will only ever
start on 1 node in the cluster at a time. If the node providing the
service is shutdown, or fails, another node on which the service was
installed will start automatically.</p>
</div>
<div class="sect2">
<h3 id="installing-an-msc-service-using-an-existing-singleton-policy">11.1. Installing an MSC service using an existing singleton policy</h3>
<div class="paragraph">
<p>While singleton MSC services have been around since AS7, WildFly 10 adds
the ability to leverage the singleton subsystem to create singleton MSC
services from existing singleton policies.</p>
</div>
<div class="paragraph">
<p>The singleton subsystem exposes capabilities for each singleton policy
it defines. These policies, represented via the
<code>org.wildfly.clustering.singleton.SingletonPolicy</code> interface, can be
referenced via the following name:
"org.wildfly.clustering.singleton.policy"<br>
e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">MyServiceActivator</span> <span class="directive">implements</span> ServiceActivator {
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> activate(ServiceActivatorContext context) {
        ServiceName name = ServiceName.parse(<span class="string"><span class="delimiter">&quot;</span><span class="content">my.service.name</span><span class="delimiter">&quot;</span></span>);
        Service&lt;?&gt; service = <span class="keyword">new</span> MyService();
        <span class="keyword">try</span> {
            SingletonPolicy policy = (SingletonPolicy) context.getServiceRegistry().getRequiredService(ServiceName.parse(SingletonPolicy.CAPABILITY_NAME)).awaitValue();
            policy.createSingletonServiceBuilder(name, service).build(context.getServiceTarget()).install();
        } <span class="keyword">catch</span> (<span class="exception">InterruptedException</span> e) {
            <span class="keyword">throw</span> <span class="keyword">new</span> ServiceRegistryException(e);
        }
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="installing-an-msc-service-using-dynamic-singleton-policy">11.2. Installing an MSC service using dynamic singleton policy</h3>
<div class="paragraph">
<p>Alternatively, you can build singleton policy dynamically, which is
particularly useful if you want to use a custom singleton election
policy. Specifically, <code>SingletonPolicy</code> is a generalization of the
<code>org.wildfly.clustering.singleton.SingletonServiceBuilderFactory</code>
interface, which includes support for specifying an election policy and,
optionally, a quorum.<br>
e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">MyServiceActivator</span> <span class="directive">implements</span> ServiceActivator {
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> activate(ServiceActivatorContext context) {
        <span class="predefined-type">String</span> containerName = <span class="string"><span class="delimiter">&quot;</span><span class="content">server</span><span class="delimiter">&quot;</span></span>;
        ElectionPolicy policy = <span class="keyword">new</span> MySingletonElectionPolicy();
        <span class="type">int</span> quorum = <span class="integer">3</span>;
        ServiceName name = ServiceName.parse(<span class="string"><span class="delimiter">&quot;</span><span class="content">my.service.name</span><span class="delimiter">&quot;</span></span>);
        Service&lt;?&gt; service = <span class="keyword">new</span> MyService();
        <span class="keyword">try</span> {
            SingletonServiceBuilderFactory factory = (SingletonServiceBuilderFactory) context.getServiceRegistry().getRequiredService(SingletonServiceName.BUILDER.getServiceName(containerName))).awaitValue();
            factory.createSingletonServiceBuilder(name, service)
                .electionPolicy(policy)
                .quorum(quorum)
                .build(context.getServiceTarget()).install();
        } <span class="keyword">catch</span> (<span class="exception">InterruptedException</span> e) {
            <span class="keyword">throw</span> <span class="keyword">new</span> ServiceRegistryException(e);
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_related_topics">12. Related Topics</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section describes additional issues related to the clustering
subsystems.</p>
</div>
<div class="sect2">
<h3 id="modularity-and-class-loading">12.1. Modularity And Class Loading</h3>
<div class="paragraph">
<p>Describe classloading and monitoring framework as it affects clustering
applications.</p>
</div>
</div>
<div class="sect2">
<h3 id="monitoring">12.2. Monitoring</h3>
<div class="paragraph">
<p>Describe resources available for monitoring clustered applications.</p>
</div>
<div class="paragraph">
<p>include::high-availability-guide/Changes From Previous Versions}</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_clustering_and_domain_setup_walkthrough">13. Clustering and Domain Setup Walkthrough</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this article, I&#8217;d like to show you how to setup WildFly 9 in domain
mode and enable clustering so we could get HA and session replication
among the nodes. It&#8217;s a step to step guide so you can follow the
instructions in this article and build the sandbox by yourself <span class="icon yellow"><i class="fa fa-smile-o"></i></span></p>
</div>
<div class="sect2">
<h3 id="preparation-scenario">13.1. Preparation &amp; Scenario</h3>
<div class="sect3">
<h4 id="preparation">13.1.1. Preparation</h4>
<div class="paragraph">
<p>We need to prepare two hosts (or virtual hosts) to do the experiment. We
will use these two hosts as following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Install Fedora 16 on them (Other linux version may also fine but I&#8217;ll
use Fedora 16 in this article)</p>
</li>
<li>
<p>Make sure that they are in same local network</p>
</li>
<li>
<p>Make sure that they can access each other via different TCP/UDP
ports(better turn off firewall and disable SELinux during the experiment
or they will cause network problems).</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="scenario">13.1.2. Scenario</h4>
<div class="paragraph">
<p>Here are some details on what we are going to do:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Let&#8217;s call one host as 'master', the other one as 'slave'.</p>
</li>
<li>
<p>Both master and slave will run WildFly 9, and master will run as
domain controller, slave will under the domain management of master.</p>
</li>
<li>
<p>Apache httpd will be run on master, and in httpd we will enable the
mod_cluster module. The WildFly 9 on master and slave will form a
cluster and discovered by httpd.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/download/attachments/557290/Clustering.jpg" alt="images/download/attachments/557290/Clustering.jpg"></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>We will deploy a demo project into domain, and verify that the project
is deployed into both master and slave by domain controller. Thus we
could see that domain management provide us a single point to manage the
deployments across multiple hosts in a single domain.</p>
</li>
<li>
<p>We will access the cluster URL and verify that httpd has distributed
the request to one of the WildFly host. So we could see the cluster is
working properly.</p>
</li>
<li>
<p>We will try to make a request on cluster, and if the request is
forwarded to master, we then kill the WildFly process on master. After
that we will go on requesting cluster and we should see the request is
forwarded to slave, but the session is not lost. Our goal is to verify
the HA is working and sessions are replicated.</p>
</li>
<li>
<p>After previous step finished, we reconnect the master by restarting
it. We should see the master is registered back into cluster, also we
should see slave sees master as domain controller again and connect to
it.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/download/attachments/557290/test_scenario.jpg" alt="images/download/attachments/557290/test_scenario.jpg"></span></p>
</div>
<div class="paragraph">
<p>Please don&#8217;t worry if you cannot digest so many details currently. Let&#8217;s
move on and you will get the points step by step.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="download-wildfly-9">13.2. Download WildFly 9</h3>
<div class="paragraph">
<p>First we should download WildFly 9 from the website:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>http://wildfly.org/downloads/</code></pre>
</div>
</div>
<div class="paragraph">
<p>The version I downloaded is WildFly 9.0.0.Final.</p>
</div>
<div class="paragraph">
<p>After download finished, I got the zip file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">wildfly-<span class="float">9.0</span><span class="float">.0</span>.Final.zip</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note: The name of your archive will differ slightly due to version
naming conventions.<br>
Then I unzipped the package to master and try to make a test run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">unzip wildfly-<span class="float">9.0</span><span class="float">.0</span>.Final.zip
cd wildfly-<span class="float">9.0</span><span class="float">.0</span>.Final/bin
./domain.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>If everything ok we should see WildFly successfully startup in domain
mode:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">wildfly-<span class="float">9.0</span><span class="float">.0</span>.Final/bin<span class="error">$</span> ./domain.sh
=========================================================================
<span class="error"> </span>
  JBoss Bootstrap Environment
<span class="error"> </span>
  JBOSS_HOME: /Users/weli/Downloads/wildfly-<span class="float">9.0</span><span class="float">.0</span>.Final
<span class="error"> </span>
  JAVA: /Library/Java/Home/bin/java
<span class="error"> </span>
  JAVA_OPTS: -Xms64m -Xmx512m -XX:MaxPermSize=<span class="integer">256</span>m -Djava.net.preferIPv4Stack=<span class="predefined-constant">true</span> -Dorg.jboss.resolver.warning=<span class="predefined-constant">true</span> -Dsun.rmi.dgc.client.gcInterval=<span class="integer">3600000</span> -Dsun.rmi.dgc.server.gcInterval=<span class="integer">3600000</span> -Djboss.modules.system.pkgs=org.jboss.byteman -Djava.awt.headless=<span class="predefined-constant">true</span>
<span class="error"> </span>
=========================================================================
...
<span class="error"> </span>
[Server:server-two] <span class="integer">14</span>:<span class="integer">46</span>:<span class="integer">12</span>,<span class="integer">375</span> INFO  [org.jboss.as] (Controller Boot <span class="predefined-type">Thread</span>) JBAS015874: WildFly <span class="float">9.0</span><span class="float">.0</span>.Final <span class="string"><span class="delimiter">&quot;</span><span class="content">Kenny</span><span class="delimiter">&quot;</span></span> started in <span class="integer">8860</span>ms - Started <span class="integer">210</span> of <span class="integer">258</span> services (<span class="integer">89</span> services are lazy, passive or on-demand)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now exit master and let&#8217;s repeat the same steps on slave host. Finally
we get WildFly 11 run on both master and slave, then we could move on to
next step.</p>
</div>
</div>
<div class="sect2">
<h3 id="domain-configuration">13.3. Domain Configuration</h3>
<div class="sect3">
<h4 id="interface-config-on-master">13.3.1. Interface config on master</h4>
<div class="paragraph">
<p>In this section we&#8217;ll setup both master and slave for them to run in
domain mode. And we will configure master to be the domain controller.</p>
</div>
<div class="paragraph">
<p>First open the host.xml in master for editing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">vi domain/configuration/host.xml</code></pre>
</div>
</div>
<div class="paragraph">
<p>The default settings for interface in this file is like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;interfaces&gt;</span>
    <span class="tag">&lt;interface</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">management</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;inet-address</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jboss.bind.address.management:127.0.0.1}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/interface&gt;</span>
    <span class="tag">&lt;interface</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">public</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
       <span class="tag">&lt;inet-address</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jboss.bind.address:127.0.0.1}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/interface&gt;</span>
    <span class="tag">&lt;interface</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">unsecured</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>       
       <span class="tag">&lt;inet-address</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">127.0.0.1</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>    
    <span class="tag">&lt;/interface&gt;</span>
<span class="tag">&lt;/interfaces&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We need to change the address to the management interface so slave could
connect to master. The public interface allows the application to be
accessed by non-local HTTP, and the unsecured interface allows remote
RMI access. My master&#8217;s ip address is 10.211.55.7, so I change the
config to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;interfaces&gt;</span>
    <span class="tag">&lt;interface</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">management</span><span class="delimiter">&quot;</span></span>
        <span class="error">&lt;</span><span class="attribute-name">inet-address</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jboss.bind.address.management:10.211.55.7}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/interface&gt;</span>
    <span class="tag">&lt;interface</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">public</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
       <span class="tag">&lt;inet-address</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jboss.bind.address:10.211.55.7}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/interface&gt;</span>    
    <span class="tag">&lt;interface</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">unsecured</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
       <span class="tag">&lt;inet-address</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10.211.55.7</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>    
    <span class="tag">&lt;/interface&gt;</span>
<span class="tag">&lt;/interfaces&gt;</span> </code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="interface-config-on-slave">13.3.2. Interface config on slave</h4>
<div class="paragraph">
<p>Now we will setup interfaces on slave. Let&#8217;s edit host.xml. Similar to
the steps on master, open host.xml first:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">vi domain/configuration/host.xml</code></pre>
</div>
</div>
<div class="paragraph">
<p>The configuration we&#8217;ll use on slave is a little bit different, because
we need to let slave connect to master. First we need to set the
hostname. We change the name property from:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;host</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">master</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:domain:3.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;host</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">slave</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:domain:3.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then we need to modify domain-controller section so slave can connect to
master&#8217;s management port:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;domain-controller&gt;</span>
   <span class="tag">&lt;remote</span> <span class="attribute-name">protocol</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">remote</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">host</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10.211.55.7</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">9999</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/domain-controller&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As we know, 10.211.55.7 is the ip address of master.<br>
You may use discovery options to define multiple mechanisms to connect
to the remote domain controller :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;domain-controller&gt;</span>
 <span class="tag">&lt;remote</span> <span class="attribute-name">security-realm</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ManagementRealm</span><span class="delimiter">&quot;</span></span> <span class="tag">&gt;</span>
   <span class="tag">&lt;discovery-options&gt;</span>
     <span class="tag">&lt;static-discovery</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">master-native</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">protocol</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">remote</span><span class="delimiter">&quot;</span></span>  <span class="attribute-name">host</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10.211.55.7</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port</span>=<span class="attribute-value">9999</span><span class="error">&quot;</span> <span class="tag">/&gt;</span>
     <span class="tag">&lt;static-discovery</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">master-https</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">protocol</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https-remoting</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">host</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10.211.55.7</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">9993</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">security-realm</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ManagementRealm</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
     <span class="tag">&lt;static-discovery</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">master-http</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">protocol</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http-remoting</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">host</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10.211.55.7</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">9990</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
   <span class="tag">&lt;/discovery-options&gt;</span>
        <span class="tag">&lt;/remote&gt;</span>
    <span class="tag">&lt;/domain-controller&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, we also need to configure interfaces section and expose the
management ports to public address:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;interfaces&gt;</span>
    <span class="tag">&lt;interface</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">management</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;inet-address</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jboss.bind.address.management:10.211.55.2}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/interface&gt;</span>
    <span class="tag">&lt;interface</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">public</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
       <span class="tag">&lt;inet-address</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jboss.bind.address:10.211.55.2}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/interface&gt;</span>
    <span class="tag">&lt;interface</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">unsecured</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>       
       <span class="tag">&lt;inet-address</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10.211.55.2</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>    
    <span class="tag">&lt;/interface&gt;</span>
<span class="tag">&lt;/interfaces&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>10.211.55.2 is the ip address of the slave. Refer to the domain
controller configuration above for an explanation of the management,
public, and unsecured interfaces.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
It is easier to turn off all firewalls for testing, but in production,
you need to enable the firewall and allow access to the following ports:
9999.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="security-configuration">13.3.3. Security Configuration</h4>
<div class="paragraph">
<p>If you start WildFly on both master and slave now, you will see the
slave cannot be started with following error:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">[Host Controller] <span class="integer">20</span>:<span class="integer">31</span>:<span class="integer">24</span>,<span class="integer">575</span> ERROR [org.jboss.remoting.remote] (Remoting <span class="string"><span class="delimiter">&quot;</span><span class="content">endpoint</span><span class="delimiter">&quot;</span></span> read-<span class="integer">1</span>) JBREM000200: <span class="predefined-type">Remote</span> connection failed: javax.security.sasl.SaslException: Authentication failed: all available authentication mechanisms failed
[Host Controller] <span class="integer">20</span>:<span class="integer">31</span>:<span class="integer">24</span>,<span class="integer">579</span> WARN  [org.jboss.as.host.controller] (Controller Boot <span class="predefined-type">Thread</span>) JBAS010900: Could not connect to remote domain controller <span class="float">10.211</span><span class="float">.55</span><span class="float">.7</span>:<span class="integer">9999</span>
[Host Controller] <span class="integer">20</span>:<span class="integer">31</span>:<span class="integer">24</span>,<span class="integer">582</span> ERROR [org.jboss.as.host.controller] (Controller Boot <span class="predefined-type">Thread</span>) JBAS010901: Could not connect to master. Aborting. Error was: java.lang.IllegalStateException: JBAS010942: Unable to connect due to authentication failure.</code></pre>
</div>
</div>
<div class="paragraph">
<p>Because we haven&#8217;t properly set up the authentication between master and
slave. Now let&#8217;s work on it:</p>
</div>
<div class="sect4">
<h5 id="master">Master</h5>
<div class="paragraph">
<p>In bin directory there is a script called add-user.sh, we&#8217;ll use it to
add new users to the properties file used for domain management
authentication:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">./add-user.sh
 
Enter the details of the new user to add.
Realm (ManagementRealm) :
Username : admin
Password recommendations are listed below. To modify these restrictions edit the add-user.properties configuration file.
 - The password should not be one of the following restricted values {root, admin, administrator}
 - The password should contain at least 8 characters, 1 alphabetic character(s), 1 digit(s), 1 non-alphanumeric symbol(s)
 - The password should be different from the username
Password : passw0rd!
Re-enter Password : passw0rd!
The username 'admin' is easy to guess
Are you sure you want to add user 'admin' yes/no? yes
About to add user 'admin' for realm 'ManagementRealm'
Is this correct yes/no? yes
Added user 'admin' to file '/home/weli/projs/wildfly-9.0.0.Final/standalone/configuration/mgmt-users.properties'
Added user 'admin' to file '/home/weli/projs/wildfly-9.0.0.Final/domain/configuration/mgmt-users.properties'</code></pre>
</div>
</div>
<div class="paragraph">
<p>As shown above, we have created a user named 'admin' and its password is
'passw0rd!'. Then we add another user called 'slave':</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">./add-user.sh
 
Enter the details of the new user to add.
Realm (ManagementRealm) :
Username : slave
Password recommendations are listed below. To modify these restrictions edit the add-user.properties configuration file.
 - The password should not be one of the following restricted values {root, admin, administrator}
 - The password should contain at least 8 characters, 1 alphabetic character(s), 1 digit(s), 1 non-alphanumeric symbol(s)
 - The password should be different from the username
Password : passw0rd!
Re-enter Password : passw0rd!
What groups do you want this user to belong to? (Please enter a comma separated list, or leave blank for none)[  ]:
About to add user 'slave' for realm 'ManagementRealm'
Is this correct yes/no? yes
Added user 'slave' to file '/home/weli/projs/wildfly-9.0.0.Final/standalone/configuration/mgmt-users.properties'
Added user 'slave' to file '/home/weli/projs/wildfly-9.0.0.Final/domain/configuration/mgmt-users.properties'
Added user 'slave' with groups  to file '/home/weli/projs/wildfly-9.0.0.Final/standalone/configuration/mgmt-groups.properties'
Added user 'slave' with groups  to file '/home/weli/projs/wildfly-9.0.0.Final/domain/configuration/mgmt-groups.properties'
Is this new user going to be used for one AS process to connect to another AS process?
e.g. for a slave host controller connecting to the master or for a Remoting connection for server to server EJB calls.
yes/no? yes
To represent the user add the following to the server-identities definition &lt;secret value=&quot;cGFzc3cwcmQh&quot; /&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We will use this user for slave host to connect to master. The
add-user.sh will let you choose the type of the user. Here we need to
choose 'Management User' type for both 'admin' and 'slave' account.</p>
</div>
</div>
<div class="sect4">
<h5 id="slave">Slave</h5>
<div class="paragraph">
<p>In slave we need to configure host.xml for authentication. We should
change the security-realms section as following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">&lt;security-realms&gt;
   &lt;security-realm name=<span class="string"><span class="delimiter">&quot;</span><span class="content">ManagementRealm</span><span class="delimiter">&quot;</span></span>&gt;
       &lt;server-identities&gt;
           &lt;secret value=<span class="string"><span class="delimiter">&quot;</span><span class="content">cGFzc3cwcmQh</span><span class="delimiter">&quot;</span></span> /&gt;
           &lt;!-- This is required <span class="keyword">for</span> SSL remoting --&gt;
           &lt;ssl&gt;
             &lt;keystore path=<span class="string"><span class="delimiter">&quot;</span><span class="content">server.keystore</span><span class="delimiter">&quot;</span></span> relative-to=<span class="string"><span class="delimiter">&quot;</span><span class="content">jboss.domain.config.dir</span><span class="delimiter">&quot;</span></span> keystore-password=<span class="string"><span class="delimiter">&quot;</span><span class="content">jbossas</span><span class="delimiter">&quot;</span></span> alias=<span class="string"><span class="delimiter">&quot;</span><span class="content">jboss</span><span class="delimiter">&quot;</span></span> key-password=<span class="string"><span class="delimiter">&quot;</span><span class="content">jbossas</span><span class="delimiter">&quot;</span></span>/&gt;
           &lt;/ssl&gt;
       &lt;/server-identities&gt;
       &lt;authentication&gt;
           &lt;properties path=<span class="string"><span class="delimiter">&quot;</span><span class="content">mgmt-users.properties</span><span class="delimiter">&quot;</span></span> relative-to=<span class="string"><span class="delimiter">&quot;</span><span class="content">jboss.domain.config.dir</span><span class="delimiter">&quot;</span></span>/&gt;
       &lt;/authentication&gt;
   &lt;/security-realm&gt;
&lt;/security-realms&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We&#8217;ve added server-identities into security-realm, which is used for
authentication host when slave tries to connect to master. In secret
value property we have 'cGFzc3cwcmQh', which is the base64 code for
'passw0rd!'. You can generate this value by using a base64 calculator
such as the one at <a href="http://www.webutils.pl/index.php?idx=base64" class="bare">http://www.webutils.pl/index.php?idx=base64</a>.</p>
</div>
<div class="paragraph">
<p>Then in domain controller section we also need to add security-realm
property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;domain-controller&gt;</span>
   <span class="tag">&lt;remote</span> <span class="attribute-name">protocol</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">remote</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">host</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10.211.55.7</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">9999</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">username</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">slave</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">security-realm</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ManagementRealm</span><span class="delimiter">&quot;</span></span>  <span class="tag">/&gt;</span>
<span class="tag">&lt;/domain-controller&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So the slave host could use the authentication information we provided
in 'ManagementRealm'.</p>
</div>
</div>
<div class="sect4">
<h5 id="dry-run">Dry Run</h5>
<div class="paragraph">
<p>Now everything is set for the two hosts to run in domain mode. Let&#8217;s
start them by running domain.sh on both hosts. If everything goes fine,
we could see from the log on master:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">[Host Controller] <span class="integer">21</span>:<span class="integer">30</span>:<span class="integer">52</span>,<span class="octal">042</span> INFO  [org.jboss.as.domain] (management-handler-threads - <span class="integer">1</span>) JBAS010918: Registered remote slave host slave</code></pre>
</div>
</div>
<div class="paragraph">
<p>That means all the configurations are correct and two hosts are run in
domain mode now as expected. Hurrah!</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="deployment">13.4. Deployment</h3>
<div class="paragraph">
<p>Now we can deploy a demo project into the domain. I have created a
simple project located at:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">https:<span class="comment">//github.com/liweinan/cluster-demo</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can use git command to fetch a copy of the demo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">git clone git:<span class="comment">//github.com/liweinan/cluster-demo.git</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this demo project we have a very simple web application. In web.xml
we&#8217;ve enabled session replication by adding following entry:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;distributable</span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And it contains a jsp page called put.jsp which will put current time to
a session entry called 'current.time':</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">&lt;%
    session.setAttribute(<span class="string"><span class="delimiter">&quot;</span><span class="content">current.time</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> java.util.Date());
%&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then we could fetch this value from get.jsp:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">The time is &lt;%= session.getAttribute(<span class="string"><span class="delimiter">&quot;</span><span class="content">current.time</span><span class="delimiter">&quot;</span></span>) %&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s an extremely simple project but it could help us to test the
cluster later: We will access put.jsp from cluster and see the request
are distributed to master, then we disconnect master and access get.jsp.
We should see the request is forwarded to slave but the 'current.time'
value is held by session replication. We&#8217;ll cover more details on this
one later.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s go back to this demo project. Now we need to create a war from it.
In the project directory, run the following command to get the war:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>mvn package</code></pre>
</div>
</div>
<div class="paragraph">
<p>It will generate cluster-demo.war. Then we need to deploy the war into
domain. First we should access the http management console on
master(Because master is acting as domain controller):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>http://10.211.55.7:9990</code></pre>
</div>
</div>
<div class="paragraph">
<p>It will popup a windows ask you to input account name and password, we
can use the 'admin' account we&#8217;ve added just now. After logging in we
could see the 'Server Instances' window. By default there are three
servers listed, which are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>server-one</p>
</li>
<li>
<p>server-two</p>
</li>
<li>
<p>server-three</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We could see server-one and server-two are in running status and they
belong to main-server-group; server-three is in idle status, and it
belongs to other-server-group.</p>
</div>
<div class="paragraph">
<p>All these servers and server groups are set in domain.xml on master as7.
What we are interested in is the 'other-server-group' in domain.xml:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;server-group</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">other-server-group</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">profile</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ha</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;jvm</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
       <span class="tag">&lt;heap</span> <span class="attribute-name">size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">64m</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">max-size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">512m</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
   <span class="tag">&lt;/jvm&gt;</span>
   <span class="tag">&lt;socket-binding-group</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ha-sockets</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/server-group&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We could see this server-group is using 'ha' profile, which then uses
'ha-sockets' socket binding group. It enable all the modules we need to
establish cluster later(including infinispan, jgroup and mod_cluster
modules). So we will deploy our demo project into a server that belongs
to 'other-server-group', so 'server-three' is our choice.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
In newer version of WildFly, the profile 'ha' changes to 'full-ha':
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">&lt;server-group name=<span class="string"><span class="delimiter">&quot;</span><span class="content">other-server-group</span><span class="delimiter">&quot;</span></span> profile=<span class="string"><span class="delimiter">&quot;</span><span class="content">full-ha</span><span class="delimiter">&quot;</span></span>&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s go back to domain controller&#8217;s management console:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">http:<span class="comment">//10.211.55.7:9990</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now server-three is not running, so let&#8217;s click on 'server-three' and
then click the 'start' button at bottom right of the server list. Wait a
moment and server-three should start now.</p>
</div>
<div class="paragraph">
<p>Now we should also enable 'server-three' on slave: From the top of menu
list on left side of the page, we could see now we are managing master
currently. Click on the list, and click 'slave', then choose
'server-three', and we are in slave host management page now.</p>
</div>
<div class="paragraph">
<p>Then repeat the steps we&#8217;ve done on master to start 'server-three' on
slave.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
server-three on master and slave are two different hosts, their names
can be different.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>After server-three on both master and slave are started, we will add our
cluster-demo.war for deployment. Click on the 'Manage Deployments' link
at the bottom of left menu list.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/download/attachments/557290/JBoss_Management.png" alt="images/download/attachments/557290/JBoss_Management.png"></span><br>
(We should ensure the server-three should be started on both master and
slave)</p>
</div>
<div class="paragraph">
<p>After enter 'Manage Deployments' page, click 'Add Content' at top right
corner. Then we should choose our cluster-demo.war, and follow the
instruction to add it into our content repository.</p>
</div>
<div class="paragraph">
<p>Now we can see cluster-demo.war is added. Next we click 'Add to Groups'
button and add the war to 'other-server-group' and then click 'save'.</p>
</div>
<div class="paragraph">
<p>Wait a few seconds, management console will tell you that the project is
deployed into 'other-server-group'.：</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/download/attachments/557290/JBoss_Management_2.png" alt="images/download/attachments/557290/JBoss_Management_2.png"></span></p>
</div>
<div class="paragraph">
<p>Please note we have two hosts participate in this server group, so the
project should be deployed in both master and slave now - that&#8217;s the
power of domain management.</p>
</div>
<div class="paragraph">
<p>Now let&#8217;s verify this, trying to access cluster-demo from both master
and slave, and they should all work now:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>http://10.211.55.7:8330/cluster-demo/</code></pre>
</div>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/download/attachments/557290/http---10.211.55.7-8330-cluster-demo-.png" alt="images/download/attachments/557290/http---10.211.55.7-8330-cluster-demo-.png"></span></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>http://10.211.55.2:8330/cluster-demo/</code></pre>
</div>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/download/attachments/557290/http---10.211.55.2-8330-cluster-demo-.png" alt="images/download/attachments/557290/http---10.211.55.2-8330-cluster-demo-.png"></span></p>
</div>
<div class="paragraph">
<p>Now that we have finished the project deployment and see the usages of
domain controller, we will then head up for using these two hosts to
establish a cluster <span class="icon yellow"><i class="fa fa-smile-o"></i></span></p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Why is the port number 8330 instead of 8080? Please check the settings
in host.xml on both master and slave:
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;server</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">server-three</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">group</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">other-server-group</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">auto-start</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="comment">&lt;!-- server-three avoids port conflicts by incrementing the ports in
         the default socket-group declared in the server-group --&gt;</span>
    <span class="tag">&lt;socket-bindings</span> <span class="attribute-name">port-offset</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">250</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/server&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The port-offset is set to 250, so 8080 + 250 = 8330</p>
</div>
<div class="paragraph">
<p>Now we quit the WildFly process on both master and slave. We have some
work left on host.xml configurations. Open the host.xml of master, and
do some modifications the servers section from:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;server</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">server-three</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">group</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">other-server-group</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">auto-start</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="comment">&lt;!-- server-three avoids port conflicts by incrementing the ports in
         the default socket-group declared in the server-group --&gt;</span>
    <span class="tag">&lt;socket-bindings</span> <span class="attribute-name">port-offset</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">250</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/server&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;server</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">server-three</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">group</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">other-server-group</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">auto-start</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="comment">&lt;!-- server-three avoids port conflicts by incrementing the ports in
         the default socket-group declared in the server-group --&gt;</span>
    <span class="tag">&lt;socket-bindings</span> <span class="attribute-name">port-offset</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">250</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/server&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We&#8217;ve set auto-start to true so we don&#8217;t need to enable it in management
console each time WildFly restart. Now open slave&#8217;s host.xml, and modify
the server-three section:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;server</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">server-three-slave</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">group</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">other-server-group</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">auto-start</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="comment">&lt;!-- server-three avoids port conflicts by incrementing the ports in
         the default socket-group declared in the server-group --&gt;</span>
    <span class="tag">&lt;socket-bindings</span> <span class="attribute-name">port-offset</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">250</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/server&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Besides setting auto-start to true, we&#8217;ve renamed the 'server-three' to
'server-three-slave'. We need to do this because mod_cluster will fail
to register the hosts with same name in a single server group. It will
cause name conflict.</p>
</div>
<div class="paragraph">
<p>After finishing the above configuration, let&#8217;s restart two as7 hosts and
go on cluster configuration.</p>
</div>
</div>
<div class="sect2">
<h3 id="cluster-configuration">13.5. Cluster Configuration</h3>
<div class="paragraph">
<p>We will use mod_cluster + apache httpd on master as our cluster
controller here. Because WildFly 11 has been configured to support
mod_cluster out of box so it&#8217;s the easiest way.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The WildFly 11 domain controller and httpd are not necessary to be on
same host. But in this article I just install them all on master for
convenience.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>First we need to ensure that httpd is installed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">sudo yum install httpd</code></pre>
</div>
</div>
<div class="paragraph">
<p>And then we need to download newer version of mod_cluster from its
website:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>http://www.jboss.org/mod_cluster/downloads</code></pre>
</div>
</div>
<div class="paragraph">
<p>The version I downloaded is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>http://downloads.jboss.org/mod_cluster/1.1.3.Final/mod_cluster-1.1.3.Final-linux2-x86-so.tar.gz</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Jean-Frederic has suggested to use mod_cluster 1.2.x. Because 1.1.x it
is affected by CVE-2011-4608
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>With mod_cluster-1.2.0 you need to add EnableMCPMReceive in the
VirtualHost.</p>
</div>
<div class="paragraph">
<p>Then we extract it into:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>/etc/httpd/modules</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then we edit httpd.conf:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">sudo vi /etc/httpd/conf/httpd.conf</code></pre>
</div>
</div>
<div class="paragraph">
<p>We should add the modules:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>LoadModule slotmem_module modules/mod_slotmem.so
LoadModule manager_module modules/mod_manager.so
LoadModule proxy_cluster_module modules/mod_proxy_cluster.so
LoadModule advertise_module modules/mod_advertise.so</code></pre>
</div>
</div>
<div class="paragraph">
<p>Please note we should comment out:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="error">#</span>LoadModule proxy_balancer_module modules/mod_proxy_balancer.so</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is conflicted with cluster module. And then we need to make httpd
to listen to public address so we could do the testing. Because we
installed httpd on master host so we know the ip address of it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>Listen 10.211.55.7:80</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then we do the necessary configuration at the bottom of httpd.conf:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code># This Listen port is for the mod_cluster-manager, where you can see the status of mod_cluster.
# Port 10001 is not a reserved port, so this prevents problems with SELinux.
Listen 10.211.55.7:10001
# This directive only applies to Red Hat Enterprise Linux. It prevents the temmporary
# files from being written to /etc/httpd/logs/ which is not an appropriate location.
MemManagerFile /var/cache/httpd
 
&lt;VirtualHost 10.211.55.7:10001&gt;
 
  &lt;Directory /&gt;
    Order deny,allow
    Deny from all
    Allow from 10.211.55.
  &lt;/Directory&gt;
 
 
  # This directive allows you to view mod_cluster status at URL http://10.211.55.4:10001/mod_cluster-manager
  &lt;Location /mod_cluster-manager&gt;
   SetHandler mod_cluster-manager
   Order deny,allow
   Deny from all
   Allow from 10.211.55.
  &lt;/Location&gt;
 
  KeepAliveTimeout 60
  MaxKeepAliveRequests 0
 
  ManagerBalancerName other-server-group
  AdvertiseFrequency 5
 
&lt;/VirtualHost&gt;</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
For more details on mod_cluster configurations please see this document:
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">http:<span class="comment">//docs.jboss.org/mod_cluster/1.1.0/html/Quick_Start_Guide.html</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="testing">13.6. Testing</h3>
<div class="paragraph">
<p>If everything goes fine we can start httpd service now:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">service httpd start</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we access the cluster:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>http://10.211.55.7/cluster-demo/put.jsp</code></pre>
</div>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/download/attachments/557290/http---10.211.55.7-cluster-demo-put.jsp.png" alt="images/download/attachments/557290/http---10.211.55.7-cluster-demo-put.jsp.png"></span></p>
</div>
<div class="paragraph">
<p>We should see the request is distributed to one of the hosts(master or
slave) from the WildFly log. For me the request is sent to master:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>[Server:server-three] 16:06:22,256 INFO  [stdout] (http-10.211.55.7-10.211.55.7-8330-4) Putting date now</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now I disconnect master by using the management interface. Select
'runtime' and the server 'master' in the upper corners.</p>
</div>
<div class="paragraph">
<p>Select 'server-three' and kick the stop button, the active-icon should
change.</p>
</div>
<div class="paragraph">
<p>Killing the server by using system commands will have the effect that
the Host-Controller restart the instance imediately!</p>
</div>
<div class="paragraph">
<p>Then wait for a few seconds and access cluster:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>http://10.211.55.7/cluster-demo/get.jsp</code></pre>
</div>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/download/attachments/557290/http---10.211.55.7-cluster-demo-get.jsp.png" alt="images/download/attachments/557290/http---10.211.55.7-cluster-demo-get.jsp.png"></span></p>
</div>
<div class="paragraph">
<p>Now the request should be served by slave and we should see the log from
slave:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">[Server:server-three-slave] 16:08:29,860 INFO  [stdout] (http-10.211.55.2-10.211.55.2-8330-1) Getting date now</code></pre>
</div>
</div>
<div class="paragraph">
<p>And from the get.jsp we should see that the time we get is the same
we&#8217;ve put by 'put.jsp'. Thus it&#8217;s proven that the session is correctly
replicated to slave.</p>
</div>
<div class="paragraph">
<p>Now we restart master and should see the host is registered back to
cluster.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
It doesn&#8217;t matter if you found the request is distributed to slave at
first time. Then just disconnect slave and do the testing, the request
should be sent to master instead. The point is we should see the request
is redirect from one host to another and the session is held.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="special-thanks">13.7. Special Thanks</h3>
<div class="paragraph">
<p><a href="https://community.jboss.org/people/wdfink">Wolf-Dieter Fink</a> has
contributed the updated add-user.sh usages and configs in host.xml from
7.1.0.Final.<br>
<a href="https://community.jboss.org/people/jfclere">Jean-Frederic Clere</a> provided
the mod_cluster 1.2.0 usages.<br>
Misty Stanley-Jones has given a lot of suggestions and helps to make
this document readable.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version {version}<br>
Last updated 2017-09-13 15:47:36 DST
</div>
</div>
</body>
</html>