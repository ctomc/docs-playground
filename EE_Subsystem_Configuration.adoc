EE Subsystem Configuration - Latest WildFly Documentation
=========================================================

[[ee-subsystem-configuration]]
EE Subsystem Configuration
--------------------------

[[overview]]
Overview
~~~~~~~~

The EE subsystem provides common functionality in the Java EE platform,
such as the EE Concurrency Utilities (JSR 236) and `@Resource`
injection. The subsystem is also responsible for managing the lifecycle
of Java EE application's deployments, that is, `.ear` files.

The EE subsystem configuration may be used to:

* customise the deployment of Java EE applications
* create EE Concurrency Utilities instances
* define the default bindings

The subsystem name is ee and this document covers EE subsystem version
`2.0`, which XML namespace within WildFly XML configurations is 
`urn:jboss:domain:ee:2.0`. The path for the subsystem's XML schema,
within WildFly's distribution, is `docs/schema/jboss-as-ee_2_0.xsd`.

Subsystem XML configuration example with all elements and attributes
specified:

[source,brush:,xml;,gutter:,false;]
----
<subsystem xmlns="urn:jboss:domain:ee:2.0" >
    <global-modules>
        <module name="org.jboss.logging"
                slot="main"/>
        <module name="org.apache.log4j"
                annotations="true"
                meta-inf="true"
                services="false" />
    </global-modules>
    <ear-subdeployments-isolated>true</ear-subdeployments-isolated>
    <spec-descriptor-property-replacement>false</spec-descriptor-property-replacement>
    <jboss-descriptor-property-replacement>false</jboss-descriptor-property-replacement>
    <annotation-property-replacement>false</annotation-property-replacement>
    <concurrent>
        <context-services>
            <context-service
                    name="default"
                    jndi-name="java:jboss/ee/concurrency/context/default"
                    use-transaction-setup-provider="true" />
        </context-services>
        <managed-thread-factories>
            <managed-thread-factory
                    name="default"
                    jndi-name="java:jboss/ee/concurrency/factory/default"
                    context-service="default"
                    priority="1" />
        </managed-thread-factories>
        <managed-executor-services>
            <managed-executor-service
                    name="default"
                    jndi-name="java:jboss/ee/concurrency/executor/default"
                    context-service="default"
                    thread-factory="default"
                    hung-task-threshold="60000"
                    core-threads="5"
                    max-threads="25"
                    keepalive-time="5000"
                    queue-length="1000000"
                    reject-policy="RETRY_ABORT" />
        </managed-executor-services>
        <managed-scheduled-executor-services>
            <managed-scheduled-executor-service
                    name="default"
                    jndi-name="java:jboss/ee/concurrency/scheduler/default"
                    context-service="default"
                    thread-factory="default"
                    hung-task-threshold="60000"
                    core-threads="5"
                    keepalive-time="5000"
                    reject-policy="RETRY_ABORT" />
        </managed-scheduled-executor-services>
    </concurrent>
    <default-bindings
            context-service="java:jboss/ee/concurrency/context/default"
            datasource="java:jboss/datasources/ExampleDS"
            jms-connection-factory="java:jboss/DefaultJMSConnectionFactory"
            managed-executor-service="java:jboss/ee/concurrency/executor/default"
            managed-scheduled-executor-service="java:jboss/ee/concurrency/scheduler/default"
            managed-thread-factory="java:jboss/ee/concurrency/factory/default" />
</subsystem>
----

[[java-ee-application-deployment]]
Java EE Application Deployment
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The EE subsystem configuration allows the customisation of the
deployment behaviour for Java EE Applications.

[[global-modules]]
Global Modules
^^^^^^^^^^^^^^

Global modules is a set of JBoss Modules that will be added as
dependencies to the JBoss Module of every Java EE deployment. Such
dependencies allows Java EE deployments to see the classes exported by
the global modules.

Each global module is defined through the `module` resource, an example
of its XML configuration:

[source,brush:,xml;,gutter:,false;]
----
  <global-modules>
    <module name="org.jboss.logging" slot="main"/>
    <module name="org.apache.log4j" annotations="true" meta-inf="true" services="false" />
  </global-modules>
----

The only mandatory attribute is the JBoss Module `name`, the `slot`
attribute defaults to `main`, and both define the JBoss Module ID to
reference.

The optional `annotations` attribute, which defaults to `false`,
indicates if a pre-computed annotation index should be imported from
META-INF/jandex.idx

The optional `services` attribute indicates if any services exposed in
META-INF/services should be made available to the deployments class
loader, and defaults to `false`.

The optional `meta-inf` attribute, which defaults to `true`, indicates
if the Module's `META-INF` path should be available to the deployment's
class loader.

[[ear-subdeployments-isolation]]
EAR Subdeployments Isolation
^^^^^^^^^^^^^^^^^^^^^^^^^^^^

A flag indicating whether each of the subdeployments within a `.ear` can
access classes belonging to another subdeployment within the same
`.ear`. The default value is `false`, which allows the subdeployments to
see classes belonging to other subdeployments within the `.ear`.

[source,brush:,xml;,gutter:,false;]
----
  <ear-subdeployments-isolated>true</ear-subdeployments-isolated>
----

For example:

[source,java]
----
myapp.ear
|
|--- web.war
|
|--- ejb1.jar
|
|--- ejb2.jar
----

If the `ear-subdeployments-isolated` is set to false, then the classes
in `web.war` can access classes belonging to `ejb1.jar` and `ejb2.jar`.
Similarly, classes from `ejb1.jar` can access classes from `ejb2.jar`
(and vice-versa).

This flag has no effect on the isolated classloader of the `.war`
file(s), i.e. irrespective of whether this flag is set to `true` or
`false`, the `.war` within a `.ear` will have a isolated classloader,
and other subdeployments within that `.ear` will not be able to access
classes from that `.war`. This is as per spec.

[[property-replacement]]
Property Replacement
^^^^^^^^^^^^^^^^^^^^

The EE subsystem configuration includes flags to configure whether
system property replacement will be done on XML descriptors and Java
Annotations included in Java EE deployments.

System properties etc are resolved in the security context of the
application server itself, not the deployment that contains the file.
This means that if you are running with a security manager and enable
this property, a deployment can potentially access system properties or
environment entries that the security manager would have otherwise
prevented.

[[spec-descriptor-property-replacement]]
Spec Descriptor Property Replacement
++++++++++++++++++++++++++++++++++++

Flag indicating whether system property replacement will be performed on
standard Java EE XML descriptors. If not configured this defaults to
`true`, however it is set to `false` in the standard configuration files
shipped with WildFly.

[source,brush:,xml;,gutter:,false;]
----
  <spec-descriptor-property-replacement>false</spec-descriptor-property-replacement>
----

[[jboss-descriptor-property-replacement]]
JBoss Descriptor Property Replacement
+++++++++++++++++++++++++++++++++++++

Flag indicating whether system property replacement will be performed on
WildFly proprietary XML descriptors, such as `jboss-app.xml`. This
defaults to `true`.

[source,brush:,xml;,gutter:,false;]
----
  <jboss-descriptor-property-replacement>false</jboss-descriptor-property-replacement>
----

[[annotation-property-replacement]]
Annotation Property Replacement
+++++++++++++++++++++++++++++++

Flag indicating whether system property replacement will be performed on
Java annotations. The default value is  `false`.

[source,brush:,xml;,gutter:,false;]
----
  <annotation-property-replacement>false</annotation-property-replacement>
----

[[ee-concurrency-utilities]]
EE Concurrency Utilities
~~~~~~~~~~~~~~~~~~~~~~~~

EE Concurrency Utilities (JSR 236) were introduced with Java EE 7, to
ease the task of writing multithreaded Java EE applications. Instances
of these utilities are managed by WildFly, and the related configuration
provided by the EE subsystem.

[[context-services]]
Context Services
^^^^^^^^^^^^^^^^

The Context Service is a concurrency utility which creates contextual
proxies from existent objects. WildFly Context Services are also used to
propagate the context from a Java EE application invocation thread, to
the threads internally used by the other EE Concurrency Utilities.
Context Service instances may be created using the subsystem XML
configuration:

[source,brush:,xml;,gutter:,false;]
----
  <context-services>
    <context-service
 name="default"
 jndi-name="java:jboss/ee/concurrency/context/default"
 use-transaction-setup-provider="true" />
  </context-services>
----

The `name` attribute is mandatory, and it's value should be a unique
name within all Context Services.

The `jndi-name` attribute is also mandatory, and defines where in the
JNDI the Context Service should be placed.

The optional `use-trasaction-setup-provider` attribute indicates if the
contextual proxies built by the Context Service should suspend
transactions in context, when invoking the proxy objects, and its value
defaults to true.

Management clients, such as the WildFly CLI, may also be used to
configure Context Service instances. An example to `add` and `remove`
one named `other`:

[source,java]
----
/subsystem=ee/context-service=other:add(jndi-name=java\:jboss\/ee\/concurrency\/other)
/subsystem=ee/context-service=other:remove
----

[[managed-thread-factories]]
Managed Thread Factories
^^^^^^^^^^^^^^^^^^^^^^^^

The Managed Thread Factory allows Java EE applications to create new
threads. WildFly Managed Thread Factory instances may also, optionally,
use a Context Service instance to propagate the Java EE application
thread’s context to the new threads. Instance creation is done through
the EE subsystem, by editing the subsystem XML configuration:

[source,brush:,xml;,gutter:,false;]
----
  <managed-thread-factories>
    <managed-thread-factory
 name="default"
 jndi-name="java:jboss/ee/concurrency/factory/default"
 context-service="default"
 priority="1" />
  </managed-thread-factories>
----

The  `name` attribute is mandatory, and it's value should be a unique
name within all Managed Thread Factories.

The  `jndi-name` attribute is also mandatory, and defines where in the
JNDI the Managed Thread Factory should be placed.

The optional  `context-service` references an existent Context Service
by its `name`. If specified then thread created by the factory will
propagate the invocation context, present when creating the thread.

The optional  `priority` indicates the priority for new threads created
by the factory, and defaults to `5`.

Management clients, such as the WildFly CLI, may also be used to
configure Managed Thread Factory instances. An example to `add` and
`remove` one named `other`:

[source,java]
----
/subsystem=ee/managed-thread-factory=other:add(jndi-name=java\:jboss\/ee\/factory\/other)
/subsystem=ee/managed-thread-factory=other:remove
----

[[managed-executor-services]]
Managed Executor Services
^^^^^^^^^^^^^^^^^^^^^^^^^

The Managed Executor Service is the Java EE adaptation of Java SE
Executor Service, providing to Java EE applications the functionality of
asynchronous task execution. WildFly is responsible to manage the
lifecycle of Managed Executor Service instances, which are specified
through the EE subsystem XML configuration:

[source,brush:,xml;,gutter:,false;]
----
  <managed-executor-services>
    <managed-executor-service
 name="default"
 jndi-name="java:jboss/ee/concurrency/executor/default"
 context-service="default"
 thread-factory="default"
 hung-task-threshold="60000"
 core-threads="5"
 max-threads="25"
 keepalive-time="5000"
 queue-length="1000000"
 reject-policy="RETRY_ABORT" />
  </managed-executor-services>
----

The  `name` attribute is mandatory, and it's value should be a unique
name within all Managed Executor Services.

The  `jndi-name` attribute is also mandatory, and defines where in the
JNDI the Managed Executor Service should be placed.

The optional  `context-service` references an existent Context Service
by its  `name`. If specified then the referenced Context Service will
capture the invocation context present when submitting a task to the
executor, which will then be used when executing the task.

The optional  `thread-factory` references an existent Managed Thread
Factory by its  `name`, to handle the creation of internal threads. If
not specified then a Managed Thread Factory with default configuration
will be created and used internally.

The mandatory  `core-threads` provides the number of threads to keep in
the executor's pool, even if they are idle. A value of  `0` means there
is no limit.

The optional  `queue-length` indicates the number of tasks that can be
stored in the input queue. The default value is `0`, which means the
queue capacity is unlimited.

The executor’s task queue is based on the values of the attributes 
`core-threads` and `queue-length`:

* If `queue-length` is `0`, or `queue-length` is
`Integer.MAX_VALUE (2147483647)` and `core-threads` is `0`, direct
handoff queuing strategy will be used and a synchronous queue will be
created.
* If `queue-length` is `Integer.MAX_VALUE` but `core-threads` is not
`0`, an unbounded queue will be used.
* For any other valid value for `queue-length`, a bounded queue wil be
created.

The optional  `hung-task-threshold` defines a threshold value, in
milliseconds, to hung a possibly blocked task. A value of  `0` will
never hung a task, and is the default.

The optional  `long-running-tasks` is a hint to optimize the execution
of long running tasks, and defaults to `false`.

The optional  `max-threads` defines the the maximum number of threads
used by the executor, which defaults to Integer.MAX_VALUE (2147483647).

The optional  `keepalive-time` defines the time, in milliseconds, that
an internal thread may be idle. The attribute default value is `60000`.

The optional reject-policy defines the policy to use when a task is
rejected by the executor. The attribute value may be the default
`ABORT`, which means an exception should be thrown, or `RETRY_ABORT`,
which means the executor will try to submit it once more, before
throwing an exception. 

Management clients, such as the WildFly CLI, may also be used to
configure Managed Executor Service instances. An example to `add` and
`remove` one named `other`:

[source,java]
----
/subsystem=ee/managed-executor-service=other:add(jndi-name=java\:jboss\/ee\/executor\/other, core-threads=2)
/subsystem=ee/managed-executor-service=other:remove
----

[[managed-scheduled-executor-services]]
Managed Scheduled Executor Services
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

The Managed Scheduled Executor Service is the Java EE adaptation of Java
SE Scheduled Executor Service, providing to Java EE applications the
functionality of scheduling task execution. WildFly is responsible to
manage the lifecycle of Managed Scheduled Executor Service instances,
which are specified through the EE subsystem XML configuration:

[source,brush:,xml;,gutter:,false;]
----
  <managed-scheduled-executor-services>
    <managed-scheduled-executor-service
 name="default"
 jndi-name="java:jboss/ee/concurrency/scheduler/default"
 context-service="default"
 thread-factory="default"
 hung-task-threshold="60000"
 core-threads="5"
 keepalive-time="5000"
 reject-policy="RETRY_ABORT" />
  </managed-scheduled-executor-services>
----

The  `name` attribute is mandatory, and it's value should be a unique
name within all Managed Scheduled Executor Services.

The  `jndi-name` attribute is also mandatory, and defines where in the
JNDI the Managed Scheduled Executor Service should be placed.

The optional  `context-service` references an existent Context Service
by its  `name`. If specified then the referenced Context Service will
capture the invocation context present when submitting a task to the
executor, which will then be used when executing the task.

The optional  `thread-factory` references an existent Managed Thread
Factory by its  `name`, to handle the creation of internal threads. If
not specified then a Managed Thread Factory with default configuration
will be created and used internally.

The mandatory  `core-threads` provides the number of threads to keep in
the executor's pool, even if they are idle. A value of  `0` means there
is no limit.

The optional  `hung-task-threshold` defines a threshold value, in
milliseconds, to hung a possibly blocked task. A value of  `0` will
never hung a task, and is the default.

The optional  `long-running-tasks` is a hint to optimize the execution
of long running tasks, and defaults to  `false`.

The optional  `keepalive-time` defines the time, in milliseconds, that
an internal thread may be idle. The attribute default value is  `60000`.

The optional reject-policy defines the policy to use when a task is
rejected by the executor. The attribute value may be the default 
`ABORT`, which means an exception should be thrown, or `RETRY_ABORT`,
which means the executor will try to submit it once more, before
throwing an exception. 

Management clients, such as the WildFly CLI, may also be used to
configure Managed Scheduled Executor Service instances. An example to
`add` and `remove` one named `other`:

[source,java]
----
/subsystem=ee/managed-scheduled-executor-service=other:add(jndi-name=java\:jboss\/ee\/scheduler\/other, core-threads=2)
/subsystem=ee/managed-scheduled-executor-service=other:remove
----

[[default-ee-bindings]]
Default EE Bindings
~~~~~~~~~~~~~~~~~~~

The Java EE Specification mandates the existence of a default instance
for each of the following resources:

* Context Service
* Datasource
* JMS Connection Factory
* Managed Executor Service
* Managed Scheduled Executor Service
* Managed Thread Factory

The EE subsystem looks up the default instances from JNDI, using the
names in the default bindings configuration, before placing those in the
standard JNDI names, such as `java:comp/DefaultManagedExecutorService`:

[source,brush:,xml;,gutter:,false;]
----
  <default-bindings
 context-service="java:jboss/ee/concurrency/context/default"
 datasource="java:jboss/datasources/ExampleDS"
 jms-connection-factory="java:jboss/DefaultJMSConnectionFactory"
 managed-executor-service="java:jboss/ee/concurrency/executor/default"
 managed-scheduled-executor-service="java:jboss/ee/concurrency/scheduler/default"
 managed-thread-factory="java:jboss/ee/concurrency/factory/default" />
----

The default bindings are optional, if the jndi name for a default
binding is not configured then the related resource will not be
available to Java EE applications.
